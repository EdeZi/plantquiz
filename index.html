<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Plant‚ÄôQuiz ‚Äî Accueil / Normal / R√©vision / P√©dantix</title>
<style>
  :root{--bg:#f7f7f8;--fg:#111;--muted:#666;--brand:#111;--ok:#16a34a;--ko:#ef4444}
  *{box-sizing:border-box} :focus-visible{outline:3px solid #11133b;outline-offset:2px}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(1.5) blur(6px);background:rgba(255,255,255,.7);border-bottom:1px solid #e5e7eb}
  nav{display:flex;gap:12px;align-items:center;max-width:1120px;margin:0 auto;padding:12px 24px}
  .brand{font-size:20px;font-weight:800;cursor:pointer}
  .back{appearance:none;border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .container{max-width:1120px;margin:0 auto;padding:24px}
  .grid{display:grid;gap:14px} .grid3{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:20px}
  .btn{appearance:none;border:0;border-radius:999px;padding:10px 16px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
  .btn[disabled]{background:#9ca3af;cursor:not-allowed} .btn.outline{background:#fff;color:#111;border:1px solid #e5e7eb}
  .muted{color:var(--muted)}
  .choices{display:grid;gap:10px;margin-top:12px}
  .choice{padding:14px 16px;border:1px solid #e5e7eb;border-radius:14px;text-align:left;background:#fff;color:#111;cursor:pointer}
  .choice:hover{box-shadow:0 2px 12px rgba(0,0,0,.06)}
  .answer.ok{border-color:var(--ok);box-shadow:0 0 0 3px rgba(22,163,74,.2)}
  .answer.ko{border-color:var(--ko);box-shadow:0 0 0 3px rgba(239,68,68,.2)}
  .row{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
  .rowL{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .field{display:grid;gap:6px}
  select, input[type="text"]{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px}
  .group{border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:8px}
  .pill{padding:4px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;font-size:12px}
  .pedantix-text{line-height:1.7; font-size:1.05rem}
  .mask{background:#111;color:#111;border-radius:4px;padding:1px 2px}
  .token{display:inline}
  .pillScore{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-size:12px}
  .exp{margin-top:10px;padding:12px;border:1px dashed #e5e7eb;border-radius:12px;background:#fafafa}
</style>
</head>
<body>
<header>
  <nav>
    <button id="backBtn" class="back" hidden>‚Üê Retour</button>
    <div id="brand" class="brand">üåø Plant‚ÄôQuiz</div>
  </nav>
</header>

<main class="container">
  <!-- ACCUEIL -->
  <section id="home">
    <div class="grid grid3">
      <div class="card">
        <h3>Quiz normal</h3>
        <p class="muted">Plus tu r√©ponds juste, plus ton Elo monte et la difficult√© augmente.</p>
        <div class="row"><button data-go="normal" class="btn">Commencer</button></div>
      </div>
      <div class="card">
        <h3>Quiz r√©vision (par semestre)</h3>
        <p class="muted">Choisis un semestre (S5 √† S9), coche des UE et r√©vise avec un quiz cibl√©.</p>
        <div class="row"><button data-go="revision" class="btn">S√©lectionner des UE</button></div>
      </div>
      <div class="card">
        <h3>P√©dantix v√©g√©tal (du jour)</h3>
        <p class="muted">Texte √† trous : tape des mots pour d√©voiler et devine le titre cach√©.</p>
        <div class="row"><button data-go="pedantix" class="btn">Jouer</button></div>
      </div>
    </div>
    <p class="muted" style="text-align:center;margin-top:22px">Donn√©es dans <code>/data/</code> : <code>questions_normal.json</code>, <code>revision_index.json</code>, <code>pedantix_daily.json</code>.</p>
  </section>

  <!-- NORMAL -->
  <section id="normal" hidden>
    <div class="card">
      <h2 style="margin:0 0 6px">Quiz normal</h2>
      <p class="muted">Plus tu r√©ponds juste, plus ton Elo monte et la difficult√© augmente.</p>
      <hr style="margin:12px 0"/>
      <article>
        <div class="rowL" style="justify-content:flex-start;gap:8px;margin-bottom:6px">
          <span class="pill">Elo: <b id="eloPill2">1000</b></span>
          <button id="setEloBtn" class="btn outline" title="R√©gler manuellement ton Elo">‚ÜïÔ∏è R√©gler Elo</button>
          <span class="pill">Q: <b id="qPill2">0</b></span>
          <span class="pill">Bonnes: <b id="goodPill2">0</b></span>
          <span class="pill">Streak: <b id="streakPill2">0</b> <span id="streakNote2" class="muted"></span></span>
        </div>
        <h3 id="qPrompt"></h3>
        <div class="choices" id="choices"></div>
        <div id="explain" class="exp" hidden></div>
        <div class="row">
          <button id="nextBtn" class="btn" disabled>Question suivante</button>
        </div>
      </article>
    </div>
  </section>

  <!-- R√âVISION -->
  <section id="revision" hidden>
    <div class="card">
      <h2 style="margin:0 0 8px">R√©vision ‚Äî Choix des UE</h2>
      <div class="rowL">
        <label class="field" style="min-width:220px"><span class="muted">Semestre</span>
          <select id="selSem">
            <option value="S5">S5</option>
            <option value="S6">S6</option>
            <option value="S7">S7</option>
            <option value="S8">S8</option>
            <option value="S9">S9</option>
          </select>
        </label>
      </div>
      <div class="row" style="gap:8px;margin:10px 0">
        <button id="btnAllCore" class="btn outline">Tout Tronc commun</button>
        <button id="btnAllOpt" class="btn outline">Tout Options</button>
        <button id="btnClear" class="btn outline">Tout d√©cocher</button>
      </div>
      <div class="group"><b>Tronc commun</b><div id="ueCore"></div></div>
      <div class="group"><b>Options</b><div id="ueOpt"></div></div>
      <div class="row" style="justify-content:flex-start">
        <button id="revLaunch" class="btn" disabled>Lancer</button>
      </div>
    </div>
  </section>

  <!-- P√âDANTIX DAILY -->
  <section id="pedantix" hidden>
    <div class="card">
      <div class="rowL" style="justify-content:space-between">
        <h2 style="margin:0">P√©dantix du jour <span id="pedScore" class="pillScore" hidden></span></h2>
        <div class="rowL">
          <button id="pedReset" class="btn outline">R√©initialiser du jour</button>
          <button id="pedHint" class="btn outline">Indice (r√©v√®le un mot)</button>
        </div>
      </div>
      <p class="muted" id="pedTitleMask"></p>
      <div id="pedText" class="pedantix-text"></div>
      <div class="row" style="justify-content:flex-start;margin-top:12px">
        <input id="pedInput" class="choice" placeholder="Tape un mot (objectif : le titre cach√©)" />
      </div>
      <ol id="pedGuesses" class="results"></ol>
    </div>
  </section>
</main>

<script>
/* ========= Helpers & √©tat commun ========= */
const $ = id => document.getElementById(id);
// NOTE compat: Safari/anciens moteurs JS ne supportent pas \\p{Diacritic}. On retire les diacritiques via U+0300‚ÄìU+036F.
const strip = s => (s||'').normalize('NFD').replace(/[\\u0300-\\u036f]/g,'').toLowerCase();

/* ========= Navigation ========= */
function go(mode){
  ['home','normal','revision','pedantix'].forEach(id=>$(id).hidden=true);
  $(mode).hidden=false;
  $('backBtn').hidden = (mode==='home');
  // try/catch au cas o√π certaines WebViews n'autorisent pas history API
  try { history.replaceState({}, '', mode==='home' ? location.pathname : `?mode=${mode}`); } catch {}
}
$('brand').onclick=()=>go('home');
$('backBtn').onclick=()=>go('home');

/* ========= Chargement data ========= */
async function tryFetch(path){
  try{
    const r=await fetch(path,{cache:'no-store'});
    if(!r.ok) throw 0;
    return await r.json();
  } catch{
    return null;
  }
}
const todayISO = (()=>{ const d=new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; })();
const DEMO_QUESTIONS=[{id:'demo1',level:4,prompt:'Quelle partie r√©alise la photosynth√®se ?',choices:[{id:'a',text:'Racines'},{id:'b',text:'Feuilles',correct:true},{id:'c',text:'Fleurs'},{id:'d',text:'Graines'}],explanation:'Les feuilles contiennent des chloroplastes.'}];

/* ===== R√©vision: index S5..S9 (tronc commun + options) ===== */
const REV_INDEX = {
  semesters: [
    {
      sem:'S5',
      core:[
        {id:'S5_dev_plantes',label:'D√©veloppement des plantes'},
        {id:'S5_genetique_fonctionnelle',label:'G√©n√©tique fonctionnelle'},
        {id:'S5_biotechnologie',label:'Biotechnologie S5'},
        {id:'S5_bio_moleculaire',label:'Biologie Mol√©culaire'}
      ],
      options:[]
    },
    {
      sem:'S6',
      core:[
        {id:'S6_bases_agroeco',label:'Bases de l‚Äôagro√©cologie'},
        {id:'S6_autotrophie',label:'Autotrophie'},
        {id:'S6_genie_genetique',label:'G√©nie g√©n√©tique v√©g√©tal'}
      ],
      options:[]
    },
    {
      sem:'S7',
      core:[
        {id:'S7_biostat_R',label:'Biostatistiques avec R'},
        {id:'S7_dev_plantes',label:'D√©veloppement des plantes'},
        {id:'S7_interactions_PM',label:'Interactions Plantes-Microorganismes'},
        {id:'S7_bases_ecophysio',label:'Bases d\\'√©cophysiologie'},
        {id:'S7_gen_mol_veg',label:'G√©n√©tique mol√©culaire v√©g√©tale'},
        {id:'S7_ing_metabo',label:'Ing√©nierie m√©tabolique product biomol√©cules v√©g√©tales d\\'int√©'},
        {id:'S7_outils_amelio',label:'Outils pour l\\'am√©lioration des plantes'},
        {id:'S7_nutrition_plantes',label:'Nutrition des plantes'}
      ],
      options:[
        {id:'S7_opt_adaptation_signal',label:'Adaptation √† l\\'environnement et signalisation'},
        {id:'S7_opt_ing_metabo',label:'Ing√©nierie m√©tabolique product biomol√©cules v√©g√©tales d\\'int√©'},
        {id:'S7_opt_outils_amelio',label:'Outils pour l\\'am√©lioration des plantes'},
        {id:'S7_opt_bio_cell_mol_veg',label:'Biologie Cellulaire et Mol√©culaire v√©g√©tale'},
        {id:'S7_opt_patho_veg',label:'El√©ments de pathologie v√©g√©tale'}
      ]
    },
    {
      sem:'S8',
      core:[
        {id:'S8_bioinfo_donnees_bdd',label:'BioInformatique: Donn√©es et Bases de Donn√©es'},
        {id:'S8_approches_exp_biologie_plantes',label:'Approches exp√©rimentales de la biologie des plantes'},
        {id:'S8_management_projets',label:'Management de projets'}
      ],
      options:[
        {id:'S8_opt_reseaux_genes_model',label:'R√©seaux de g√®nes-Mod√©lisation'},
        {id:'S8_opt_amelio_tropicales_medit',label:'Am√©lioration des plantes tropicales et m√©diterran√©ennes'}
      ]
    },
    {
      sem:'S9',
      core:[
        {id:'S9_approche_integree',label:'Approche int√©gr√©e d\\'am√©lioration des plantes: √©tude de cas'},
        {id:'S9_epigenetique',label:'Epig√©n√©tique chez les plantes'},
        {id:'S9_bigomics',label:'BigOmics, g√©nomique comparative'},
        {id:'S9_ecophysio_ideotype',label:'Ecophysiologie: du ph√©notype √† l\\'id√©otype'},
        {id:'S9_genetique_quantitative',label:'G√©n√©tique quantitative'},
        {id:'S9_traitement_donnees',label:'Traitement de donn√©es'},
        {id:'S9_gestion_projets',label:'Gestion de projets'}
      ],
      options:[
        {id:'S9_opt_nutri_minerale',label:'Nutrition min√©rale adaptation plantes aux contraintes abioti'},
        {id:'S9_opt_expression_diff',label:'Analyse de l\\'expression diff√©rentielle de g√®nes'},
        {id:'S9_opt_ecole_signal_dyna',label:'Ecole signalisation, dyna'},
        {id:'S9_opt_plantes_modeles_modelisation',label:'Plantes mod√®les, mod√©lisation'},
        {id:'S9_opt_adaptation_grandes_cultures',label:'Adaptation grandes cultures tropicales aux changements clima'},
        {id:'S9_opt_plantes_hommes',label:'Plantes et Hommes, une histoire partag√©e'},
        {id:'S9_opt_virologie',label:'Virologie'},
        {id:'S9_opt_ecole_phytobiome',label:'Ecole phytobiome'},
        {id:'S9_opt_protection_cultures',label:'Protection des cultures'},
        {id:'S9_opt_interactions_signal',label:'Interactions et signalisation'},
        {id:'S9_opt_projet_integre',label:'Projet Int√©gr√© d\\'am√©lioration des plantes: ph√©notypes'},
        {id:'S9_opt_bioinfo_requetes',label:'BioInformatique: construire des requ√™tes'}
      ]
    }
  ]
};

const DEMO_DAILY=[{date:todayISO,target:'Chloroplaste',text:'On parle d\\'une petite structure pr√©sente dans bien des plantes. Elle capte la lumi√®re et aide la plante √† fabriquer des sucres, ce qui explique la couleur bien verte de nombreuses feuilles.'}];

let loaded=false;
let QUESTIONS_NORMAL=[], QUESTIONS=[], PED_DAILY=null;

async function loadData(){
  if(loaded) return;
  const normal = await tryFetch('./data/questions_normal.json') || DEMO_QUESTIONS;
  QUESTIONS_NORMAL = Array.isArray(normal) ? normal : DEMO_QUESTIONS;
  QUESTIONS = QUESTIONS_NORMAL;
  const daily = await tryFetch('./data/pedantix_daily.json') || DEMO_DAILY;
  PED_DAILY = daily.find(x=>x.date===todayISO) || daily[0];
  loaded=true;
}

function restoreNormalQuestions(){
  QUESTIONS = QUESTIONS_NORMAL;
  resetQuizState();
}

/* ========= MODE NORMAL ‚Äî Elo ========= */
const MAX_LEVEL=12;
const levelToRating = l => 700 + (l-1)*100;
const eloToLevel    = e => Math.min(MAX_LEVEL, Math.max(1, Math.round((e-700)/100 + 1)));

let elo=1000, level=eloToLevel(elo);
let qCount=0, goodCount=0, streak=0, wrongStreak=0, answeredTotal=0;

const BASE_K=28, CALIB_K=40;
function expected(eloA, eloB){ return 1/(1+Math.pow(10,(eloB-eloA)/400)); }
function kFactor(){
  let K = (answeredTotal<8) ? CALIB_K : BASE_K;
  if(streak>=3) K = Math.round(K*1.25);
  if(wrongStreak>=2) K = Math.round(K*0.85);
  return K;
}
function applyElo(win, qLevel){
  const rq = levelToRating(qLevel);
  const ex = expected(elo, rq);
  const K = kFactor();
  elo = Math.round(elo + K * ((win?1:0) - ex));
  level = eloToLevel(elo);
}

const recentIds=[]; const RECENT_MAX=20;
function remember(id){ recentIds.push(id); if(recentIds.length>RECENT_MAX) recentIds.shift(); }
function notRecentlyAsked(q){ return !recentIds.includes(q.id); }
function sampleLevelAround(lstar){
  const r = Math.random();
  if(r<0.45) return lstar;
  if(r<0.80) return Math.min(MAX_LEVEL, lstar+1);
  return Math.max(1, lstar-1);
}
function filteredChoicesForLevel(choices, lvl){
  if(!Array.isArray(choices)) return [];
  const arr = [...choices].sort(()=>Math.random()-0.5);
  if(lvl>=8){
    const keep = arr.filter(c=>!c.joke || c.correct);
    return keep.length? keep : arr;
  }else{
    let seenJoke=false;
    const keep=[];
    for(const c of arr){
      if(c.correct){ keep.push(c); continue; }
      if(c.joke===true){
        if(!seenJoke){ keep.push(c); seenJoke=true; }
      }else{
        keep.push(c);
      }
    }
    return keep;
  }
}
function pickQuestion(){
  if(!QUESTIONS?.length) return null;
  const lstar = eloToLevel(elo);
  const desired = sampleLevelAround(lstar);
  let pool = QUESTIONS.filter(q => (q.level||1)===desired).filter(notRecentlyAsked);
  if(!pool.length) pool = QUESTIONS.filter(q => Math.abs((q.level||1)-desired)<=1).filter(notRecentlyAsked);
  if(!pool.length) pool = QUESTIONS.filter(notRecentlyAsked);
  if(!pool.length) pool = QUESTIONS;
  const q = pool[Math.floor(Math.random()*pool.length)];
  return q;
}

let currentQ=null, locked=false;
function updateMeta(){
  $('eloPill2').textContent=elo;
  $('qPill2').textContent=qCount;
  $('goodPill2').textContent=goodCount;
  $('streakPill2').textContent=streak;
  $('streakNote2').textContent = (streak>=7?'ü•µ bouillant':streak>=4?'üî• en feu':streak>=2?'üòé √ßa progresse':streak===1?'üôÇ bien jou√©':streak===0?'':'üßä va r√©viser');
}
function renderQuestion(){
  if(!QUESTIONS?.length){
    $('qPrompt').textContent='Pas de questions (data/questions_normal.json)';
    $('choices').innerHTML=''; $('explain').hidden=true; $('nextBtn').disabled=true;
    return;
  }
  currentQ = pickQuestion(); locked=false;

  const lvl = currentQ.level || 1;
  let choices = filteredChoicesForLevel(currentQ.choices||[], lvl);
  if(!choices.some(c=>c.correct) && (currentQ.choices||[]).some(c=>c.correct)){
    const correct = currentQ.choices.find(c=>c.correct);
    choices = [correct, ...choices.filter(c=>c.id!==correct.id)];
  }

  $('qPrompt').textContent=currentQ.prompt;
  $('choices').innerHTML='';
  choices.forEach(c=>{
    const b=document.createElement('button');
    b.className='choice';
    b.textContent=c.text;
    b.onclick=()=>choose(c,b,lvl);
    $('choices').appendChild(b);
  });
  $('explain').hidden=true; $('nextBtn').disabled=true;
}
function choose(choice, btn, qLevel){
  if(locked) return; locked=true;
  qCount++; answeredTotal++;
  const correct = (currentQ.choices||[]).find(c=>c.correct);
  const win = !!(correct && correct.id===choice.id);

  if(win){ goodCount++; streak++; wrongStreak=0; btn.classList.add('answer','ok'); }
  else   { streak=0; wrongStreak++; btn.classList.add('answer','ko'); }

  [...$('choices').children].forEach(b=>{
    if(b.textContent===correct.text) b.classList.add('answer','ok');
    b.disabled=true;
  });

  applyElo(win, qLevel);
  $('explain').hidden=false;
  $('explain').innerHTML = (win?'‚úÖ Correct.':'‚ùå Incorrect.') + (currentQ.explanation?`<br>üí° ${currentQ.explanation}`:'');
  updateMeta();
  remember(currentQ.id);
  $('nextBtn').disabled=false;
}
$('nextBtn').onclick=renderQuestion;

function resetQuizState(){
  elo=1000; level=eloToLevel(elo); qCount=0; goodCount=0; streak=0; wrongStreak=0; answeredTotal=0; recentIds.length=0;
}

/* ====== Bouton Elo ====== */
$('setEloBtn').onclick = () => {
  alert('‚ö†Ô∏è Attention : n\\'utilise pas ce r√©glage pour tricher ! üêÆ');
  const v = prompt('Entre ton Elo souhait√© (ex: 1000). Plage conseill√©e: 700‚Äì1800');
  if(v===null) return;
  const n = Math.round(Number(v));
  if(Number.isNaN(n)) { alert('Valeur invalide.'); return; }
  const clamped = Math.max(400, Math.min(2400, n));
  elo = clamped;
  level = eloToLevel(elo);
  updateMeta();
};

/* ========= MODE R√âVISION (S5..S9) ========= */
const selSem = $('selSem'), ueCore=$('ueCore'), ueOpt=$('ueOpt');
function label(id,lbl){ return `<label class="pill"><input type="checkbox" data-id="${id}"> ${lbl}</label>`; }
function fillUEsForSem(sem){
  const s = REV_INDEX.semesters.find(x=>x.sem===sem);
  ueCore.innerHTML=(s && s.core ? s.core : []).map(u=>label(u.id,u.label)).join('');
  ueOpt.innerHTML=(s && s.options ? s.options : []).map(u=>label(u.id,u.label)).join('');
  $('revLaunch').disabled=true;
  document.querySelectorAll('#revision input[type=checkbox]').forEach(i=> i.onchange=()=>{ $('revLaunch').disabled=!document.querySelector('#revision input:checked'); });
}
selSem.onchange = () => fillUEsForSem(selSem.value);
$('btnAllCore').onclick=()=>{ ueCore.querySelectorAll('input').forEach(i=>i.checked=true); $('revLaunch').disabled=false; };
$('btnAllOpt').onclick=()=>{ ueOpt.querySelectorAll('input').forEach(i=>i.checked=true); $('revLaunch').disabled=false; };
$('btnClear').onclick=()=>{ document.querySelectorAll('#revision input[type=checkbox]').forEach(i=>i.checked=false); $('revLaunch').disabled=true; };

$('revLaunch').onclick=()=>{
  const picked=[...document.querySelectorAll('#revision input:checked')].map(i=>i.parentElement.textContent.trim());
  if(!picked.length) return;
  QUESTIONS = picked.map((lbl,ix)=>({
    id:`UE${ix}`,level:5,prompt:`UE: ${lbl} ‚Äî question d√©mo`,
    choices:[{id:'a',text:'A'},{id:'b',text:'B',correct:true},{id:'c',text:'C'},{id:'d',text:'D'}],
    explanation:'Placeholder √† remplacer.'
  }));
  resetQuizState();
  go('normal'); updateMeta(); renderQuestion();
};

/* ========= P√âDANTIX (daily) ========= */
const wordRe = /[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø'-]+|[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø'-]+/g;
let pedState = { date:null, target:null, text:'', tokens:[], revealed:new Set(), guessed:[] };

const IRREG_FORMS = {
  'ai':'avoir','as':'avoir','a':'avoir','avons':'avoir','avez':'avoir','ont':'avoir',
  'avais':'avoir','avait':'avoir','avions':'avoir','aviez':'avoir','avaient':'avoir',
  'aurai':'avoir','auras':'avoir','aura':'avoir','aurons':'avoir','aurez':'avoir','auront':'avoir',
  'aurais':'avoir','aurait':'avoir','aurions':'avoir','auriez':'avoir','auraient':'avoir',
  'eu':'avoir','eue':'avoir','eus':'avoir','eut':'avoir','eues':'avoir','eumes':'avoir','eutes':'avoir','eurent':'avoir',
  'ayant':'avoir',
  'suis':'etre','es':'etre','est':'etre','sommes':'etre','etes':'etre','sont':'etre',
  'etais':'etre','etait':'etre','etions':'etre','etiez':'etre','etaient':'etre',
  'serai':'etre','seras':'etre','sera':'etre','serons':'etre','serez':'etre','seront':'etre',
  'serais':'etre','serait':'etre','serions':'etre','seriez':'etre','seraient':'etre',
  'ete':'etre','etant':'etre',
  'vais':'aller','vas':'aller','va':'aller','allons':'aller','allez':'aller','vont':'aller',
  'allais':'aller','allait':'aller','allions':'aller','alliez':'aller','allaient':'aller',
  'irai':'aller','iras':'aller','ira':'aller','irons':'aller','irez':'aller','iront':'aller',
  'irais':'aller','irait':'aller','irions':'aller','iriez':'aller','iraient':'aller',
  'allant':'aller',
  'fais':'faire','fait':'faire','faisons':'faire','faites':'faire','font':'faire',
  'faisais':'faire','faisait':'faire','faisions':'faire','faisiez':'faire','faisaient':'faire',
  'ferai':'faire','feras':'faire','fera':'faire','ferons':'faire','ferez':'faire','feront':'faire',
  'ferais':'faire','ferait':'faire','ferions':'faire','feriez':'faire','feraient':'faire',
  'faisant':'faire',
  'peux':'pouvoir','peut':'pouvoir','pouvons':'pouvoir','pouvez':'pouvoir','peuvent':'pouvoir',
  'pouvais':'pouvoir','pouvait':'pouvoir','pouvions':'pouvoir','pouviez':'pouvoir','pouvaient':'pouvoir',
  'pourrai':'pouvoir','pourras':'pouvoir','pourra':'pouvoir','pourrons':'pouvoir','pourrez':'pouvoir','pourront':'pouvoir',
  'pourrais':'pouvoir','pourrait':'pouvoir','pourrions':'pouvoir','pourriez':'pouvoir','pourraient':'pouvoir',
  'pu':'pouvoir','pue':'pouvoir','pus':'pouvoir','put':'pouvoir','purent':'pouvoir',
  'pouvant':'pouvoir',
  'dois':'devoir','doit':'devoir','devons':'devoir','devez':'devoir','doivent':'devoir',
  'devais':'devoir','devait':'devoir','devions':'devoir','deviez':'devoir','devaient':'devoir',
  'devrai':'devoir','devras':'devoir','devra':'devoir','devrons':'devoir','devrez':'devoir','devront':'devoir',
  'devrais':'devoir','devrait':'devoir','devrions':'devoir','devriez':'devoir','devraient':'devoir',
  'du':'devoir','due':'devoir','dus':'devoir','dut':'devoir','durent':'devoir',
  'devant':'devoir',
  'sais':'savoir','sait':'savoir','savons':'savoir','savez':'savoir','savent':'savoir',
  'savais':'savoir','savait':'savoir','savions':'savoir','saviez':'savoir','savaient':'savoir',
  'saurai':'savoir','sauras':'savoir','saura':'savoir','saurons':'savoir','saurez':'savoir','sauront':'savoir',
  'saurais':'savoir','saurait':'savoir','saurions':'savoir','sauriez':'savoir','sauraient':'savoir',
  'su':'savoir','sachant':'savoir',
  'viens':'venir','vient':'venir','venons':'venir','venez':'venir','viennent':'venir',
  'venais':'venir','venait':'venir','venions':'venir','veniez':'venir','venaient':'venir',
  'viendrai':'venir','viendras':'venir','viendra':'venir','viendrons':'venir','viendrez':'venir','viendront':'venir',
  'viendrais':'venir','viendrait':'venir','viendrions':'venir','viendriez':'venir','viendraient':'venir',
  'venu':'venir','venant':'venir',
  'veux':'vouloir','veut':'vouloir','voulons':'vouloir','voulez':'vouloir','veulent':'vouloir',
  'voulais':'vouloir','voulait':'vouloir','voulions':'vouloir','vouliez':'vouloir','voulaient':'vouloir',
  'voudrai':'vouloir','voudras':'vouloir','voudra':'vouloir','voudrons':'vouloir','voudrez':'vouloir','voudront':'vouloir',
  'voudrais':'vouloir','voudrait':'vouloir','voudrions':'vouloir','voudriez':'vouloir','voudraient':'vouloir',
  'voulu':'vouloir','voulant':'vouloir',
  'dis':'dire','dit':'dire','disons':'dire','dites':'dire','disent':'dire',
  'disais':'dire','disait':'dire','disions':'dire','disiez':'dire','disaient':'dire',
  'dirai':'dire','diras':'dire','dira':'dire','dirons':'dire','direz':'dire','diront':'dire',
  'dirais':'dire','dirait':'dire','dirions':'dire','diriez':'dire','diraient':'dire',
  'disant':'dire',
  'mets':'mettre','met':'mettre','mettons':'mettre','mettez':'mettre','mettent':'mettre',
  'mettais':'mettre','mettait':'mettre','mettions':'mettre','mettiez':'mettre','mettaient':'mettre',
  'mettrai':'mettre','mettras':'mettre','mettra':'mettre','mettrons':'mettre','mettrez':'mettre','mettront':'mettre',
  'mettrais':'mettre','mettrait':'mettre','mettrions':'mettre','mettriez':'mettre','mettraient':'mettre',
  'mis':'mettre','mettant':'mettre',
  'prends':'prendre','prend':'prendre','prenons':'prendre','prenez':'prendre','prennent':'prendre',
  'prenais':'prendre','prenait':'prendre','prenions':'prendre','preniez':'prendre','prenaient':'prendre',
  'prendrai':'prendre','prendras':'prendre','prendra':'prendre','prendrons':'prendre','prendrez':'prendre','prendront':'prendre',
  'prendrais':'prendre','prendrait':'prendre','prendrions':'prendre','prendriez':'prendre','prendraient':'prendre',
  'pris':'prendre','prenant':'prendre',
  'vois':'voir','voit':'voir','voyons':'voir','voyez':'voir','voient':'voir',
  'voyais':'voir','voyait':'voir','voyions':'voir','voyiez':'voir','voyaient':'voir',
  'verrai':'voir','verras':'voir','verra':'voir','verrons':'voir','verrez':'voir','verront':'voir',
  'verrais':'voir','verrait':'voir','verrions':'voir','verriez':'voir','verraient':'voir',
  'vu':'voir','voyant':'voir',
  'tiens':'tenir','tient':'tenir','tenons':'tenir','tenez':'tenir','tiennent':'tenir',
  'tenais':'tenir','tenait':'tenir','tenions':'tenir','teniez':'tenir','tenaient':'tenir',
  'tiendrai':'tenir','tiendras':'tenir','tiendra':'tenir','tiendrons':'tenir','tiendrez':'tenir','tiendront':'tenir',
  'tiendrais':'tenir','tiendrait':'tenir','tiendrions':'tenir','tiendriez':'tenir','tiendraient':'tenir',
  'tenu':'tenir','tenant':'tenir',
  'pars':'partir','part':'partir','partons':'partir','partez':'partir','partent':'partir','partant':'partir',
  'sorts':'sortir','sort':'sortir','sortons':'sortir','sortez':'sortir','sortent':'sortir','sortant':'sortir',
  'bois':'boire','boit':'boire','buvons':'boire','buvez':'boire','boivent':'boire',
  'buvais':'boire','buvait':'boire','buvions':'boire','buviez':'boire','buvaient':'boire',
  'boirai':'boire','boiras':'boire','boira':'boire','boirons':'boire','boirez':'boire','boiront':'boire',
  'bu':'boire','bus':'boire','but':'boire','burent':'boire','buvant':'boire',
  'lis':'lire','lit':'lire','lisons':'lire','lisez':'lire','lisent':'lire','lisant':'lire',
  'ecris':'ecrire','ecrit':'ecrire','ecrivons':'ecrire','ecrivez':'ecrire','ecrivent':'ecrire','ecrivant':'ecrire',
  'connais':'connaitre','connait':'connaitre','connaissons':'connaitre','connaissez':'connaitre','connaissent':'connaitre','connaissant':'connaitre',
  'crois':'croire','croit':'croire','croyons':'croire','croyez':'croire','croient':'croire','croyant':'croire',
  'vis':'vivre','vit':'vivre','vivons':'vivre','vivez':'vivre','vivent':'vivre','vivant':'vivre',
  'ouvre':'ouvrir','ouvres':'ouvrir','ouvrons':'ouvrir','ouvrez':'ouvrir','ouvrent':'ouvrir','ouvrant':'ouvrir',
  'offre':'offrir','offres':'offrir','offrons':'offrir','offrez':'offrir','offrent':'offrir','offrant':'offrir',
  'cours':'courir','court':'courir','courons':'courir','courez':'courir','courent':'courir','courant':'courir',
  'ris':'rire','rit':'rire','rions':'rire','riez':'rire','rient':'rire','ri':'rire','riant':'rire',
  'souris':'sourire','sourit':'sourire','sourions':'sourire','souriez':'sourire','sourient':'sourire','souri':'sourire','souriant':'sourire',
  'envoie':'envoyer','envoies':'envoyer','envoyons':'envoyer','envoyez':'envoyer','envoient':'envoyer','envoyant':'envoyer',
  'recois':'recevoir','recoit':'recevoir','recevons':'recevoir','recevez':'recevoir','recoivent':'recevoir','recevant':'recevoir',
  'vaux':'valoir','vaut':'valoir','valons':'valoir','valez':'valoir','valent':'valoir','valu':'valoir','valant':'valoir',
  'pleut':'pleuvoir','pleuvait':'pleuvoir','pleuvra':'pleuvoir','plu':'pleuvoir','pleuvant':'pleuvoir'
};

function lemmaFr(rawWord){
  let w = strip(rawWord.replace(/^([ldmtscnj])'|^qu'|^jusqu'|^lorsqu'|^puisqu'/i, ''));
  if (!w) return w;
  if (IRREG_FORMS[w]) return IRREG_FORMS[w];

  if (/(ant|ante|ants|antes)$/.test(w)) {
    const stem = w.replace(/(ant|ante|ants|antes)$/, 'er');
    if (stem.length>=3) return stem;
  }
  if (/(issant|issante|issants|issantes)$/.test(w)) {
    const stem = w.replace(/(issant|issante|issants|issantes)$/, 'ir');
    if (stem.length>=3) return stem;
  }
  const rules = [
    [/(ees|ee|es|e)$/i, 'er'],
    [/ant$/i, 'er'],
    [/(ies|ie|is|it)$/i, 'ir'],
    [/(ues|ue|us|u)$/i, ''],
    [/(ais|ait|ions|iez|aient)$/i, ''],
    [/(erai|eras|era|erons|erez|eront)$/i, 'er'],
    [/(erais|erait|erions|eriez|eraient)$/i, 'er'],
    [/(e|es|ons|ez|ent)$/i, 'er'],
    [/(irai|iras|ira|irons|irez|iront)$/i, 'ir'],
    [/(irais|irait|irions|iriez|iraient)$/i, 'ir'],
    [/(issons|issez|issent)$/i, 'ir'],
    [/(is|it)$/i, 'ir'],
    [/re$/i, 're']
  ];
  for(const [re, rep] of rules){
    if(re.test(w)){
      const stem = w.replace(re, rep);
      if(stem.length>=3) return stem;
    }
  }
  return w;
}

function tokenize(text){
  const parts = text.match(wordRe) || [];
  return parts.map(p=>{
    const isWord = /[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø'-]+/.test(p);
    const norm = isWord ? strip(p) : p;
    const lemma = isWord ? lemmaFr(p) : p;
    return { raw:p, norm, lemma, isWord };
  });
}
function titleMask(){
  if(!pedState.target) return '';
  const letters = [...pedState.target];
  const masked = letters.map(ch=>{
    if(/\\s/.test(ch)) return ' ';
    if(/[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø]/.test(ch)) return '‚ñà';
    return ch;
  }).join('');
  return `Titre : ${masked} (${letters.filter(c=>/[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø]/.test(c)).length} lettres)`;
}
function renderPed(){
  $('pedTitleMask').textContent = titleMask();
  const frag = document.createDocumentFragment();
  pedState.tokens.forEach(t=>{
    const span = document.createElement('span');
    span.className = 'token';
    if(!t.isWord){ span.textContent = t.raw; }
    else {
      const show = pedState.revealed.has(t.norm) || pedState.revealed.has(t.lemma) || (t.norm===strip(pedState.target)) || (t.lemma===lemmaFr(pedState.target));
      span.innerHTML = show ? t.raw : `<span class="mask">${'‚ñà'.repeat(Math.max(1, t.raw.length))}</span>`;
    }
    frag.appendChild(span);
  });
  const host=$('pedText'); host.innerHTML=''; host.appendChild(frag);
}
function pickDaily(){
  const entry = PED_DAILY;
  pedState.date = entry?.date || todayISO;
  pedState.target = entry?.target || 'Chloroplaste';
  pedState.text = entry?.text || DEMO_DAILY[0].text;
  pedState.tokens = tokenize(pedState.text);
  pedState.revealed = new Set();
  pedState.guessed = [];
  $('pedGuesses').innerHTML=''; $('pedScore').hidden=true;
  renderPed();
}
function guessWord(w){
  const gRaw = (w||'').trim(); if(!gRaw) return {hits:0,win:false};
  const gNorm = strip(gRaw);
  const gLemma = lemmaFr(gRaw);
  const win = gNorm === strip(pedState.target) || gLemma === lemmaFr(pedState.target);
  let hits = 0;
  if(!win){
    let found=false;
    for(const t of pedState.tokens){
      if(!t.isWord) continue;
      if(t.norm===gNorm || t.lemma===gLemma){
        pedState.revealed.add(t.norm);
        pedState.revealed.add(t.lemma);
        found=true;
      }
    }
    if(found){
      hits = pedState.tokens.filter(t => t.isWord && (t.norm===gNorm || t.lemma===gLemma)).length;
    }
  }
  renderPed();
  return {hits,win};
}
function pedHint(){
  const cand=[];
  for(const t of pedState.tokens){
    if(!t.isWord) continue;
    if(t.norm===strip(pedState.target) || t.lemma===lemmaFr(pedState.target)) continue;
    if(!pedState.revealed.has(t.norm) && !pedState.revealed.has(t.lemma)){
      cand.push(t);
    }
  }
  if(!cand.length) return;
  const t = cand[Math.random()*cand.length|0];
  pedState.revealed.add(t.norm);
  pedState.revealed.add(t.lemma);
  renderPed();
}
$('pedInput').addEventListener('keydown',e=>{
  if(e.key!=='Enter') return;
  const val = $('pedInput').value.trim(); if(!val) return;
  const {hits,win} = guessWord(val);
  const li=document.createElement('li'); li.className='result-item';
  li.innerHTML=`<div class="num ${win?'ok':(hits>0?'ok':'ko')}">${$('pedGuesses').children.length+1}</div><div><b>${val}</b> ‚Äî ${win?'üéØ Titre trouv√© !':(hits>0?`${hits} occurrence(s)`:'0')}</div>`;
  $('pedGuesses').prepend(li);
  if(win){ $('pedScore').hidden=false; $('pedScore').textContent='BRAVO !'; }
  $('pedInput').value='';
});
$('pedReset').onclick=pickDaily;
$('pedHint').onclick=pedHint;

/* ========= Handlers d‚Äôaccueil ========= */
document.querySelectorAll('[data-go]').forEach(b=>{
  b.addEventListener('click', async () => {
    await loadData();
    const m=b.dataset.go;
    if(m==='normal'){
      restoreNormalQuestions();
      go('normal'); updateMeta(); renderQuestion();
    } else if(m==='revision'){
      go('revision'); fillUEsForSem(selSem.value);
    } else if(m==='pedantix'){
      go('pedantix'); pickDaily();
    }
  });
});

/* ========= Boot ========= */
const urlMode = new URLSearchParams(location.search).get('mode') || 'home';
(async function boot(){
  if(urlMode==='home'){ go('home'); return; }
  await loadData();
  if(urlMode==='normal'){
    restoreNormalQuestions();
    go('normal'); updateMeta(); renderQuestion();
  } else if(urlMode==='revision'){
    go('revision'); fillUEsForSem(selSem.value);
  } else if(urlMode==='pedantix'){
    go('pedantix'); pickDaily();
  } else {
    go('home');
  }
})();
</script>
</body>
</html>
