<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Plant‚ÄôQuiz ‚Äî Accueil / Normal / R√©vision / P√©dantix</title>
<style>
  :root{--bg:#f7f7f8;--fg:#111;--muted:#666;--brand:#111;--ok:#16a34a;--ko:#ef4444}
  *{box-sizing:border-box} :focus-visible{outline:3px solid #11133b;outline-offset:2px}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(1.5) blur(6px);background:rgba(255,255,255,.7);border-bottom:1px solid #e5e7eb}
  nav{display:flex;gap:12px;align-items:center;max-width:1120px;margin:0 auto;padding:12px 24px}
  .brand{font-size:20px;font-weight:800;cursor:pointer}
  .back{appearance:none;border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .metaRow{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
  .pill{padding:4px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;font-size:12px}
  .container{max-width:1120px;margin:0 auto;padding:24px}
  .grid{display:grid;gap:14px} .grid3{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:20px}
  .btn{appearance:none;border:0;border-radius:999px;padding:10px 16px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
  .btn[disabled]{background:#9ca3af;cursor:not-allowed} .btn.outline{background:#fff;color:#111;border:1px solid #e5e7eb}
  .muted{color:var(--muted)}
  .choices{display:grid;gap:10px;margin-top:12px}
  .choice{padding:14px 16px;border:1px solid #e5e7eb;border-radius:14px;text-align:left;background:#fff;color:#111;cursor:pointer}
  .choice:hover{box-shadow:0 2px 12px rgba(0,0,0,.06)}
  .choice.selected{outline:3px solid var(--brand);border-color:var(--brand)}
  .answer.ok{border-color:var(--ok);box-shadow:0 0 0 3px rgba(22,163,74,.2)}
  .answer.ko{border-color:var(--ko);box-shadow:0 0 0 3px rgba(239,68,68,.2)}
  .row{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
  .rowL{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .field{display:grid;gap:6px}
  select, input[type="text"]{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px}
  .group{border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:8px}
  .pillMini{display:inline-block;margin:6px 8px 0 0;padding:6px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-size:12px}
  /* p√©dantix */
  .pedantix-text{line-height:1.6}
  .mask{background:#111;color:#111;border-radius:4px;padding:2px 6px;}
  .pillScore{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-size:12px}
  .exp{margin-top:10px;padding:12px;border:1px dashed #e5e7eb;border-radius:12px;background:#fafafa}
</style>
</head>
<body>
<header>
  <nav>
    <button id="backBtn" class="back" hidden>‚Üê Retour</button>
    <div id="brand" class="brand">üåø Plant‚ÄôQuiz</div>
    <div id="metaRow" class="metaRow" hidden>
      <div class="pill">Elo: <b id="eloPill">1000</b></div>
      <div class="pill">Q: <b id="qPill">0</b></div>
      <div class="pill">Bonnes: <b id="goodPill">0</b></div>
      <div class="pill">Streak: <b id="streakPill">0</b> <span id="streakNote" class="muted"></span></div>
    </div>
  </nav>
</header>

<main class="container">
  <!-- ACCUEIL -->
  <section id="home">
    <div class="grid grid3">
      <div class="card">
        <h3>Quiz normal</h3>
        <p class="muted">Difficult√© adaptative (Elo). Affiche la bonne r√©ponse + explication apr√®s chaque question.</p>
        <div class="row"><button data-go="normal" class="btn">Commencer</button></div>
      </div>
      <div class="card">
        <h3>Quiz r√©vision (par UE)</h3>
        <p class="muted">Master ‚Üí Semestre ‚Üí coche les UE. Placeholders (√† remplacer plus tard).</p>
        <div class="row"><button data-go="revision" class="btn">S√©lectionner des UE</button></div>
      </div>
      <div class="card">
        <h3>P√©dantix v√©g√©tal</h3>
        <p class="muted">Devine le mot principal d‚Äôun passage (type p√©dantix).</p>
        <div class="row"><button data-go="pedantix" class="btn">Jouer</button></div>
      </div>
    </div>
    <p class="muted" style="text-align:center;margin-top:22px">Compatible GitHub Pages ‚Äî utilise /data/*.json</p>
  </section>

  <!-- NORMAL -->
  <section id="normal" hidden>
    <div class="card">
      <h2 style="margin:0 0 6px">Quiz normal</h2>
      <p class="muted">Choisis une r√©ponse. On r√©v√®le si c‚Äôest bon + l‚Äôexplication. Ton Elo s‚Äôajuste, et on encha√Æne.</p>
      <hr style="margin:12px 0"/>
      <article>
        <h3 id="qPrompt"></h3>
        <div class="choices" id="choices"></div>
        <div id="explain" class="exp" hidden></div>
        <div class="row">
          <button id="nextBtn" class="btn" disabled>Question suivante</button>
        </div>
      </article>
    </div>
  </section>

  <!-- R√âVISION -->
  <section id="revision" hidden>
    <div class="card">
      <h2 style="margin:0 0 8px">R√©vision ‚Äî Choix des UE</h2>
      <div class="rowL">
        <label class="field"><span class="muted">Master</span><select id="selMaster"></select></label>
        <label class="field"><span class="muted">Semestre</span><select id="selSem"></select></label>
      </div>
      <div class="row" style="gap:8px;margin:10px 0">
        <button id="btnAllCore" class="btn outline">Tout Tronc commun</button>
        <button id="btnAllOpt" class="btn outline">Tout Options</button>
        <button id="btnClear" class="btn outline">Tout d√©cocher</button>
      </div>
      <div class="group"><b>Tronc commun</b><div id="ueCore"></div></div>
      <div class="group"><b>Options</b><div id="ueOpt"></div></div>
      <div class="row" style="justify-content:flex-start">
        <button id="revLaunch" class="btn" disabled>Lancer</button>
      </div>
    </div>
  </section>

  <!-- P√âDANTIX -->
  <section id="pedantix" hidden>
    <div class="card">
      <div class="rowL" style="justify-content:space-between">
        <h2 style="margin:0">P√©dantix <span id="pedScore" class="pillScore" hidden></span></h2>
        <div class="rowL">
          <button id="pedNew" class="btn">Nouveau</button>
          <button id="pedReveal" class="btn outline">Indice</button>
        </div>
      </div>
      <p class="muted" id="pedTitle"></p>
      <div id="pedText" class="pedantix-text"></div>
      <div class="row" style="justify-content:flex-start;margin-top:12px">
        <input id="pedInput" class="choice" placeholder="Propose un mot puis Entr√©e" />
      </div>
      <ol id="pedGuesses" class="results"></ol>
    </div>
  </section>
</main>

<script>
/* ===== utilitaires & √©tat ===== */
const $ = id => document.getElementById(id);
const strip = s => (s||'').normalize("NFD").replace(/\p{Diacritic}/gu,'').toLowerCase();
const LS={elo:'pq_elo', lvl:'pq_level'};
let elo = Number(localStorage.getItem(LS.elo)) || 1000;
let level = Number(localStorage.getItem(LS.lvl)) || 1;
let QUESTIONS=[], REV_INDEX=null, PED_PASSAGES=[];
let qCount=0, goodCount=0, streak=0;
const K=24, MAX_LEVEL=10;
const levelToRating = l => 800 + (l-1)*70;
function expected(eloA, eloB){ return 1/(1+Math.pow(10,(eloB-eloA)/400)); }
function applyElo(win, qLevel){
  const opp = levelToRating(qLevel||Math.max(1,Math.min(10,level)));
  elo = Math.round(elo + K*((win?1:0)-expected(elo,opp)));
  level = Math.min(MAX_LEVEL, Math.max(1, Math.round((elo-800)/70 + 1)));
  localStorage.setItem(LS.elo, elo); localStorage.setItem(LS.lvl, level);
}
function setMetaVisible(v){ $("metaRow").hidden=!v; $("backBtn").hidden=!v; }

/* ===== navigation (SPA avec query) ===== */
function go(mode){
  const sections=['home','normal','revision','pedantix'];
  sections.forEach(id=>$(id).hidden=true);
  $(mode).hidden=false;
  if(mode==='home'){ setMetaVisible(false); history.replaceState({},'',location.pathname); }
  else { setMetaVisible(true); history.replaceState({},'',`?mode=${mode}`); }
  // reset compteur visible
  $("eloPill").textContent=elo; $("qPill").textContent=qCount; $("goodPill").textContent=goodCount; $("streakPill").textContent=streak; $("streakNote").textContent=streakNote(streak);
}
$("brand").onclick=()=>go('home');
$("backBtn").onclick=()=>go('home');
document.querySelectorAll('[data-go]').forEach(b=> b.onclick=()=>go(b.dataset.go));
const urlMode = new URLSearchParams(location.search).get('mode') || 'home';

/* ===== fetch + fallbacks ===== */
async function tryFetch(path){ try{const r=await fetch(path,{cache:'no-store'}); if(!r.ok) throw 0; return await r.json();}catch{return null;} }
const DEMO_QUESTIONS=[{id:'L1Q1',level:1,prompt:'Quelle partie r√©alise la photosynth√®se ?',choices:[{id:'a',text:'Racines'},{id:'b',text:'Feuilles',correct:true},{id:'c',text:'Fleurs'},{id:'d',text:'Graines'}],explanation:'Les feuilles contiennent des chloroplastes.'},{id:'L1Q2',level:1,prompt:'Quel pigment donne la couleur verte ?',choices:[{id:'a',text:'Carot√®ne'},{id:'b',text:'Chlorophylle',correct:true},{id:'c',text:'Anthocyane'},{id:'d',text:'B√©tala√Øne'}],explanation:'La chlorophylle.'}];
const DEMO_REV={masters:[{key:'BIPA',label:'BIPA (d√©mo)',semesters:[{sem:'M1-S7',core:[{id:'biostat_R',label:'Biostatistiques avec R'}],options:[{id:'opt',label:'Option d√©mo'}]}]}]};
const DEMO_PED=[{id:'P1',title:'Photosynth√®se (d√©mo)',target:'chloroplaste',sentences:["Le CHAMP est un organite o√π se d√©roule la photosynth√®se.","Les thylako√Ødes du CHAMP portent les pigments.","Le stroma du CHAMP h√©berge le cycle de Calvin."]}];

/* ===== NORMAL (nouvelle UX) ===== */
let currentQ=null, locked=false;
function pickQuestion(){
  const near = QUESTIONS.filter(q=> Math.abs((q.level||1)-level)<=1);
  const list = near.length? near : QUESTIONS;
  return list[Math.floor(Math.random()*list.length)];
}
function renderQuestion(){
  if(!QUESTIONS.length){ $("qPrompt").textContent="Pas de questions (data/questions_normal.json)"; $("choices").innerHTML=""; $("explain").hidden=true; $("nextBtn").disabled=true; return; }
  currentQ = pickQuestion(); locked=false;
  $("qPrompt").textContent=currentQ.prompt;
  $("choices").innerHTML="";
  (currentQ.choices||[]).forEach(c=>{
    const b=document.createElement('button');
    b.className='choice';
    b.textContent=c.text;
    b.onclick=()=>choose(c,b);
    $("choices").appendChild(b);
  });
  $("explain").hidden=true;
  $("nextBtn").disabled=true;
}
function streakNote(n){
  if(n>=7) return "ü•µ bouillant";
  if(n>=4) return "üî• en feu";
  if(n>=2) return "üòé √ßa progresse";
  if(n===1) return "üôÇ bien jou√©";
  if(n===0) return "";
  return "üßä va r√©viser";
}
function choose(choice, btn){
  if(locked) return;
  locked=true;
  qCount++; $("qPill").textContent=qCount;
  const correct = (currentQ.choices||[]).find(c=>c.correct);
  const win = !!(correct && correct.id===choice.id);
  if(win){ goodCount++; streak++; btn.classList.add('answer','ok'); }
  else { streak=0; btn.classList.add('answer','ko'); }
  // marquer la bonne r√©ponse
  [...$("choices").children].forEach(b=>{
    const t=b.textContent;
    if(t===correct.text){ b.classList.add('answer','ok'); }
    b.disabled=true;
  });
  // elo
  applyElo(win, currentQ.level);
  // afficher explication
  $("explain").hidden=false;
  $("explain").innerHTML = (win? "‚úÖ Correct." : "‚ùå Incorrect.") + (currentQ.explanation? `<br>üí° ${currentQ.explanation}`:"");
  // meta pills
  $("eloPill").textContent=elo; $("goodPill").textContent=goodCount; $("streakPill").textContent=streak; $("streakNote").textContent=streakNote(streak);
  // activer suivant
  $("nextBtn").disabled=false;
}
$("nextBtn").onclick=renderQuestion;

/* ===== R√âVISION ===== */
const selMaster=$("selMaster"), selSem=$("selSem"), ueCore=$("ueCore"), ueOpt=$("ueOpt");
function fillMasters(){ selMaster.innerHTML=''; (REV_INDEX.masters||[]).forEach(m=>{ const o=document.createElement('option'); o.value=m.key; o.textContent=m.label; selMaster.appendChild(o); }); fillSems(); }
function fillSems(){ selSem.innerHTML=''; const m=(REV_INDEX.masters||[]).find(x=>x.key===selMaster.value); (m?.semesters||[]).forEach(s=>{ const o=document.createElement('option'); o.value=s.sem; o.textContent=s.sem; selSem.appendChild(o); }); fillUEs(); }
function label(id,lbl){ return `<label class="pillMini"><input type="checkbox" data-id="${id}">${lbl}</label>`; }
function fillUEs(){ const m=(REV_INDEX.masters||[]).find(x=>x.key===selMaster.value); const s=m?.semesters?.find(x=>x.sem===selSem.value);
  ueCore.innerHTML=(s?.core||[]).map(u=>label(u.id,u.label)).join(""); ueOpt.innerHTML=(s?.options||[]).map(u=>label(u.id,u.label)).join("");
  $("revLaunch").disabled=true; document.querySelectorAll("#revision input[type=checkbox]").forEach(i=> i.onchange=()=>{ $("revLaunch").disabled=!document.querySelector("#revision input:checked"); });
  $("btnAllCore").onclick=()=>{ ueCore.querySelectorAll("input").forEach(i=>i.checked=true); $("revLaunch").disabled=false; };
  $("btnAllOpt").onclick=()=>{ ueOpt.querySelectorAll("input").forEach(i=>i.checked=true); $("revLaunch").disabled=false; };
  $("btnClear").onclick=()=>{ document.querySelectorAll("#revision input[type=checkbox]").forEach(i=>i.checked=false); $("revLaunch").disabled=true; };
}
$("revLaunch").onclick=()=>{
  const picked=[...document.querySelectorAll("#revision input:checked")].map(i=>i.parentElement.textContent.trim());
  if(!picked.length) return;
  // transforme en mini-banque le temps de la session
  QUESTIONS = picked.map((lbl,ix)=>({id:'UE'+ix,level:5,prompt:`UE: ${lbl} ‚Äî question d√©mo`,choices:[{id:'a',text:'A'},{id:'b',text:'B',correct:true},{id:'c',text:'C'},{id:'d',text:'D'}],explanation:'Remplace ce placeholder plus tard.'}));
  qCount=0; goodCount=0; streak=0;
  $("eloPill").textContent=elo; $("qPill").textContent=qCount; $("goodPill").textContent=goodCount; $("streakPill").textContent=streak; $("streakNote").textContent="";
  go('normal'); // on r√©utilise l‚ÄôUI propre du normal
  renderQuestion();
};
selMaster.onchange=fillSems; selSem.onchange=fillUEs;

/* ===== P√âDANTIX ===== */
let pedCurrent=null, pedShown=1;
function maskAll(s,t){ const esc=t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); const re=new RegExp(esc,'gi'); return s.replace(re,"<span class='mask'>‚ñà‚ñà‚ñà‚ñà</span>"); }
function pickPed(){ pedCurrent = (PED_PASSAGES||[])[Math.floor(Math.random()*PED_PASSAGES.length)]; pedShown=1; renderPed(); }
function renderPed(){
  if(!PED_PASSAGES.length){ $("pedTitle").textContent="Pas de passages (data/pedantix_passages.json)"; $("pedText").innerHTML=""; $("pedGuesses").innerHTML=""; return; }
  $("pedTitle").textContent=pedCurrent.title||''; $("pedGuesses").innerHTML=''; $("pedScore").hidden=true;
  $("pedText").innerHTML = pedCurrent.sentences.slice(0,pedShown).map(s=>`<p>${maskAll(s,pedCurrent.target)}</p>`).join("");
  $("pedInput").value="";
}
$("pedInput").addEventListener('keydown',e=>{
  if(e.key!=='Enter') return;
  const g=strip($("pedInput").value); if(!g) return;
  const ok = g===strip(pedCurrent.target);
  const li=document.createElement('li'); li.className='result-item';
  li.innerHTML=`<div class="num ${ok?'ok':'ko'}">${$("pedGuesses").children.length+1}</div><div><b>${$("pedInput").value}</b> ${ok?'‚úÖ':'‚ùå'}</div>`;
  $("pedGuesses").prepend(li); if(ok){ $("pedScore").hidden=false; $("pedScore").textContent="Bravo ! Mot : "+pedCurrent.target; }
  $("pedInput").value="";
});
$("pedNew").onclick=pickPed;
$("pedReveal").onclick=()=>{ if(pedShown<(pedCurrent.sentences||[]).length){ pedShown++; renderPed(); } };

/* ===== initialisation ===== */
(async function init(){
  QUESTIONS = await tryFetch("./data/questions_normal.json") || DEMO_QUESTIONS;
  REV_INDEX = await tryFetch("./data/revision_index.json") || DEMO_REV;
  PED_PASSAGES = await tryFetch("./data/pedantix_passages.json") || DEMO_PED;

  // page d‚Äôarriv√©e
  go(urlMode);
  if(urlMode==='normal'){ qCount=0; goodCount=0; streak=0; renderQuestion(); }
  if(urlMode==='revision'){ fillMasters(); }
  if(urlMode==='pedantix'){ pickPed(); }
})();
</script>
</body>
</html>
