<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Plant‚ÄôQuiz ‚Äî Accueil / Normal / R√©vision / P√©dantix</title>
<style>
  :root{--bg:#f7f7f8;--fg:#111;--muted:#666;--brand:#111;--ok:#16a34a;--ko:#ef4444}
  *{box-sizing:border-box} :focus-visible{outline:3px solid #11133b;outline-offset:2px}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(1.5) blur(6px);background:rgba(255,255,255,.7);border-bottom:1px solid #e5e7eb}
  nav{display:flex;gap:12px;align-items:center;max-width:1120px;margin:0 auto;padding:12px 24px}
  .brand{font-size:20px;font-weight:800;cursor:pointer}
  .back{appearance:none;border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer}
  .container{max-width:1120px;margin:0 auto;padding:24px}
  .grid{display:grid;gap:14px} .grid3{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:20px}
  .btn{appearance:none;border:0;border-radius:999px;padding:10px 16px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
  .btn[disabled]{background:#9ca3af;cursor:not-allowed} .btn.outline{background:#fff;color:#111;border:1px solid #e5e7eb}
  .muted{color:var(--muted)}
  .choices{display:grid;gap:10px;margin-top:12px}
  .choice{padding:14px 16px;border:1px solid #e5e7eb;border-radius:14px;text-align:left;background:#fff;color:#111;cursor:pointer}
  .choice:hover{box-shadow:0 2px 12px rgba(0,0,0,.06)}
  .answer.ok{border-color:var(--ok);box-shadow:0 0 0 3px rgba(22,163,74,.2)}
  .answer.ko{border-color:var(--ko);box-shadow:0 0 0 3px rgba(239,68,68,.2)}
  .row{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
  .rowL{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .field{display:grid;gap:6px}
  select, input[type="text"]{padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px}
  .group{border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:8px}
  .pill{padding:4px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;font-size:12px}
  /* P√©dantix */
  .pedantix-text{line-height:1.7; font-size:1.05rem}
  .mask{background:#111;color:#111;border-radius:4px;padding:1px 2px}
  .token{display:inline}
  .pillScore{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-size:12px}
  .exp{margin-top:10px;padding:12px;border:1px dashed #e5e7eb;border-radius:12px;background:#fafafa}
</style>
</head>
<body>
<header>
  <nav>
    <button id="backBtn" class="back" hidden>‚Üê Retour</button>
    <div id="brand" class="brand">üåø Plant‚ÄôQuiz</div>
  </nav>
</header>

<main class="container">
  <!-- ACCUEIL -->
  <section id="home">
    <div class="grid grid3">
      <div class="card">
        <h3>Quiz normal</h3>
        <p class="muted">Plus tu r√©ponds juste, plus ton Elo monte et la difficult√© augmente.</p>
        <div class="row"><button data-go="normal" class="btn">Commencer</button></div>
      </div>
      <div class="card">
        <h3>Quiz r√©vision (par UE)</h3>
        <p class="muted">Choisis Master &amp; Semestre, coche des UE et r√©vise avec un quiz cibl√©.</p>
        <div class="row"><button data-go="revision" class="btn">S√©lectionner des UE</button></div>
      </div>
      <div class="card">
        <h3>P√©dantix v√©g√©tal (du jour)</h3>
        <p class="muted">Texte √† trous : tape des mots pour d√©voiler et devine le titre cach√©.</p>
        <div class="row"><button data-go="pedantix" class="btn">Jouer</button></div>
      </div>
    </div>
    <p class="muted" style="text-align:center;margin-top:22px">Donn√©es dans <code>/data/</code> : <code>questions_normal.json</code>, <code>revision_index.json</code>, <code>pedantix_daily.json</code>.</p>
  </section>

  <!-- NORMAL -->
  <section id="normal" hidden>
    <div class="card">
      <h2 style="margin:0 0 6px">Quiz normal</h2>
      <p class="muted">Plus tu r√©ponds juste, plus ton Elo monte et la difficult√© augmente.</p>
      <hr style="margin:12px 0"/>
      <article>
        <div class="rowL" style="justify-content:flex-start;gap:8px;margin-bottom:6px">
          <span class="pill">Elo: <b id="eloPill2">1000</b></span>
          <span class="pill">Q: <b id="qPill2">0</b></span>
          <span class="pill">Bonnes: <b id="goodPill2">0</b></span>
          <span class="pill">Streak: <b id="streakPill2">0</b> <span id="streakNote2" class="muted"></span></span>
        </div>
        <h3 id="qPrompt"></h3>
        <div class="choices" id="choices"></div>
        <div id="explain" class="exp" hidden></div>
        <div class="row">
          <button id="nextBtn" class="btn" disabled>Question suivante</button>
        </div>
      </article>
    </div>
  </section>

  <!-- R√âVISION -->
  <section id="revision" hidden>
    <div class="card">
      <h2 style="margin:0 0 8px">R√©vision ‚Äî Choix des UE</h2>
      <div class="rowL">
        <label class="field"><span class="muted">Master</span><select id="selMaster"></select></label>
        <label class="field"><span class="muted">Semestre</span><select id="selSem"></select></label>
      </div>
      <div class="row" style="gap:8px;margin:10px 0">
        <button id="btnAllCore" class="btn outline">Tout Tronc commun</button>
        <button id="btnAllOpt" class="btn outline">Tout Options</button>
        <button id="btnClear" class="btn outline">Tout d√©cocher</button>
      </div>
      <div class="group"><b>Tronc commun</b><div id="ueCore"></div></div>
      <div class="group"><b>Options</b><div id="ueOpt"></div></div>
      <div class="row" style="justify-content:flex-start">
        <button id="revLaunch" class="btn" disabled>Lancer</button>
      </div>
    </div>
  </section>

  <!-- P√âDANTIX DAILY -->
  <section id="pedantix" hidden>
    <div class="card">
      <div class="rowL" style="justify-content:space-between">
        <h2 style="margin:0">P√©dantix du jour <span id="pedScore" class="pillScore" hidden></span></h2>
        <div class="rowL">
          <button id="pedReset" class="btn outline">R√©initialiser du jour</button>
          <button id="pedHint" class="btn outline">Indice (r√©v√®le un mot)</button>
        </div>
      </div>
      <p class="muted" id="pedTitleMask"></p>
      <div id="pedText" class="pedantix-text"></div>
      <div class="row" style="justify-content:flex-start;margin-top:12px">
        <input id="pedInput" class="choice" placeholder="Tape un mot (objectif : le titre cach√©)" />
      </div>
      <ol id="pedGuesses" class="results"></ol>
    </div>
  </section>
</main>

<script>
/* ========= Helpers & √©tat commun ========= */
const $ = id => document.getElementById(id);
const strip = s => (s||'').normalize("NFD").replace(/\p{Diacritic}/gu,'').toLowerCase();

/* ========= Navigation ========= */
function go(mode){
  ["home","normal","revision","pedantix"].forEach(id=>$(id).hidden=true);
  $(mode).hidden=false;
  $("backBtn").hidden = (mode==="home");
  history.replaceState({}, "", mode==="home" ? location.pathname : `?mode=${mode}`);
}
$("brand").onclick=()=>go("home");
$("backBtn").onclick=()=>go("home");

/* ========= Chargement data ========= */
async function tryFetch(path){ try{ const r=await fetch(path,{cache:"no-store"}); if(!r.ok) throw 0; return await r.json(); } catch{ return null; } }
const todayISO = (()=>{ const d=new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; })();
const DEMO_QUESTIONS=[{id:"demo1",level:4,prompt:"Quelle partie r√©alise la photosynth√®se ?",choices:[{id:"a",text:"Racines"},{id:"b",text:"Feuilles",correct:true},{id:"c",text:"Fleurs"},{id:"d",text:"Graines"}],explanation:"Les feuilles contiennent des chloroplastes."}];
const DEMO_REV={masters:[{key:"BIPA",label:"BIPA (d√©mo)",semesters:[{sem:"M1-S7",core:[{id:"biostat_R",label:"Biostatistiques avec R"}],options:[{id:"opt",label:"Option d√©mo"}]}]}]};
const DEMO_DAILY=[{date:todayISO,target:"Chloroplaste",text:"On parle d'une petite structure pr√©sente dans bien des plantes. Elle capte la lumi√®re et aide la plante √† fabriquer des sucres, ce qui explique la couleur bien verte de nombreuses feuilles."}];

let loaded=false;
let QUESTIONS=[], REV_INDEX=null, PED_DAILY=null;
async function loadData(){
  if(loaded) return;
  QUESTIONS = await tryFetch("./data/questions_normal.json") || DEMO_QUESTIONS;
  REV_INDEX = await tryFetch("./data/revision_index.json")   || DEMO_REV;
  const daily = await tryFetch("./data/pedantix_daily.json") || DEMO_DAILY;
  PED_DAILY = daily.find(x=>x.date===todayISO) || daily[0];
  loaded=true;
}

/* ========= MODE NORMAL ‚Äî Elo avec niveaux internes (non affich√©s) ========= */
const MAX_LEVEL=12;
const levelToRating = l => 700 + (l-1)*100;                 // 1‚Üí700 ‚Ä¶ 12‚Üí1800
const eloToLevel    = e => Math.min(MAX_LEVEL, Math.max(1, Math.round((e-700)/100 + 1)));

let elo=1000, level=eloToLevel(elo);
let qCount=0, goodCount=0, streak=0, wrongStreak=0, answeredTotal=0;

const BASE_K=28, CALIB_K=40;
function expected(eloA, eloB){ return 1/(1+Math.pow(10,(eloB-eloA)/400)); }
function kFactor(){
  let K = (answeredTotal<8) ? CALIB_K : BASE_K; // calibration sur 8 premi√®res r√©ponses
  if(streak>=3) K = Math.round(K*1.25);         // momentum
  if(wrongStreak>=2) K = Math.round(K*0.85);    // amortisseur si 2 erreurs d‚Äôaffil√©e
  return K;
}
function applyElo(win, qLevel){
  const rq = levelToRating(qLevel);
  const ex = expected(elo, rq);
  const K = kFactor();
  elo = Math.round(elo + K * ((win?1:0) - ex));
  level = eloToLevel(elo); // interne uniquement
}

/* ‚Äî‚Äî‚Äî S√©lection des questions 45/35/20 autour du niveau estim√© (cach√©) ‚Äî‚Äî‚Äî */
const recentIds=[]; const RECENT_MAX=20;
function remember(id){ recentIds.push(id); if(recentIds.length>RECENT_MAX) recentIds.shift(); }
function notRecentlyAsked(q){ return !recentIds.includes(q.id); }
function sampleLevelAround(lstar){
  const r = Math.random();
  if(r<0.45) return lstar;
  if(r<0.80) return Math.min(MAX_LEVEL, lstar+1);
  return Math.max(1, lstar-1);
}
/* ‚Äî‚Äî‚Äî Filtrage des blagues : ‚â§7 = max 1 blague, ‚â•8 = aucune ‚Äî‚Äî‚Äî */
function filteredChoicesForLevel(choices, lvl){
  if(!Array.isArray(choices)) return [];
  const arr = [...choices].sort(()=>Math.random()-0.5);
  if(lvl>=8){
    const keep = arr.filter(c=>!c.joke || c.correct);
    return keep.length? keep : arr;
  }else{
    let seenJoke=false;
    const keep=[];
    for(const c of arr){
      if(c.correct){ keep.push(c); continue; }
      if(c.joke===true){
        if(!seenJoke){ keep.push(c); seenJoke=true; }
      }else{
        keep.push(c);
      }
    }
    return keep;
  }
}
function pickQuestion(){
  if(!QUESTIONS.length) return null;
  const lstar = eloToLevel(elo);
  const desired = sampleLevelAround(lstar);
  let pool = QUESTIONS.filter(q => (q.level||1)===desired).filter(notRecentlyAsked);
  if(!pool.length) pool = QUESTIONS.filter(q => Math.abs((q.level||1)-desired)<=1).filter(notRecentlyAsked);
  if(!pool.length) pool = QUESTIONS.filter(notRecentlyAsked);
  if(!pool.length) pool = QUESTIONS;
  const q = pool[Math.floor(Math.random()*pool.length)];
  return q;
}

/* ‚Äî‚Äî‚Äî UI du mode Normal ‚Äî‚Äî‚Äî */
let currentQ=null, locked=false;
function updateMeta(){
  $("eloPill2").textContent=elo;
  $("qPill2").textContent=qCount;
  $("goodPill2").textContent=goodCount;
  $("streakPill2").textContent=streak;
  $("streakNote2").textContent = (streak>=7?"ü•µ bouillant":streak>=4?"üî• en feu":streak>=2?"üòé √ßa progresse":streak===1?"üôÇ bien jou√©":streak===0?"":"üßä va r√©viser");
}
function renderQuestion(){
  if(!QUESTIONS.length){
    $("qPrompt").textContent="Pas de questions (data/questions_normal.json)";
    $("choices").innerHTML=""; $("explain").hidden=true; $("nextBtn").disabled=true;
    return;
  }
  currentQ = pickQuestion(); locked=false;

  const lvl = currentQ.level || 1;
  let choices = filteredChoicesForLevel(currentQ.choices||[], lvl);
  if(!choices.some(c=>c.correct) && (currentQ.choices||[]).some(c=>c.correct)){
    const correct = currentQ.choices.find(c=>c.correct);
    choices = [correct, ...choices.filter(c=>c.id!==correct.id)];
  }

  $("qPrompt").textContent=currentQ.prompt;
  $("choices").innerHTML="";
  choices.forEach(c=>{
    const b=document.createElement("button");
    b.className="choice";
    b.textContent=c.text;
    b.onclick=()=>choose(c,b,lvl);
    $("choices").appendChild(b);
  });
  $("explain").hidden=true; $("nextBtn").disabled=true;
}
function choose(choice, btn, qLevel){
  if(locked) return; locked=true;
  qCount++; answeredTotal++;
  const correct = (currentQ.choices||[]).find(c=>c.correct);
  const win = !!(correct && correct.id===choice.id);

  if(win){ goodCount++; streak++; wrongStreak=0; btn.classList.add("answer","ok"); }
  else   { streak=0; wrongStreak++; btn.classList.add("answer","ko"); }

  [...$("choices").children].forEach(b=>{
    if(b.textContent===correct.text) b.classList.add("answer","ok");
    b.disabled=true;
  });

  applyElo(win, qLevel);
  $("explain").hidden=false;
  $("explain").innerHTML = (win?"‚úÖ Correct.":"‚ùå Incorrect.") + (currentQ.explanation?`<br>üí° ${currentQ.explanation}`:"");
  updateMeta();
  remember(currentQ.id);
  $("nextBtn").disabled=false;
}
$("nextBtn").onclick=renderQuestion;

/* ========= MODE R√âVISION ========= */
const selMaster=$("selMaster"), selSem=$("selSem"), ueCore=$("ueCore"), ueOpt=$("ueOpt");
function fillMasters(){ selMaster.innerHTML=""; (REV_INDEX.masters||[]).forEach(m=>{ const o=document.createElement("option"); o.value=m.key; o.textContent=m.label; selMaster.appendChild(o); }); fillSems(); }
function fillSems(){ selSem.innerHTML=""; const m=(REV_INDEX.masters||[]).find(x=>x.key===selMaster.value); (m?.semesters||[]).forEach(s=>{ const o=document.createElement("option"); o.value=s.sem; o.textContent=s.sem; selSem.appendChild(o); }); fillUEs(); }
function label(id,lbl){ return `<label class="pill"><input type="checkbox" data-id="${id}"> ${lbl}</label>`; }
function fillUEs(){
  const m=(REV_INDEX.masters||[]).find(x=>x.key===selMaster.value);
  const s=m?.semesters?.find(x=>x.sem===selSem.value);
  ueCore.innerHTML=(s?.core||[]).map(u=>label(u.id,u.label)).join("");
  ueOpt.innerHTML=(s?.options||[]).map(u=>label(u.id,u.label)).join("");
  $("revLaunch").disabled=true;
  document.querySelectorAll("#revision input[type=checkbox]").forEach(i=> i.onchange=()=>{ $("revLaunch").disabled=!document.querySelector("#revision input:checked"); });
  $("btnAllCore").onclick=()=>{ ueCore.querySelectorAll("input").forEach(i=>i.checked=true); $("revLaunch").disabled=false; };
  $("btnAllOpt").onclick=()=>{ ueOpt.querySelectorAll("input").forEach(i=>i.checked=true); $("revLaunch").disabled=false; };
  $("btnClear").onclick=()=>{ document.querySelectorAll("#revision input[type=checkbox]").forEach(i=>i.checked=false); $("revLaunch").disabled=true; };
}
$("revLaunch").onclick=()=>{
  const picked=[...document.querySelectorAll("#revision input:checked")].map(i=>i.parentElement.textContent.trim());
  if(!picked.length) return;
  QUESTIONS = picked.map((lbl,ix)=>({id:`UE${ix}`,level:5,prompt:`UE: ${lbl} ‚Äî question d√©mo`,choices:[{id:"a",text:"A"},{id:"b",text:"B",correct:true},{id:"c",text:"C"},{id:"d",text:"D"}],explanation:"Placeholder √† remplacer."}));
  elo=1000; level=eloToLevel(elo); qCount=0; goodCount=0; streak=0; wrongStreak=0; answeredTotal=0; recentIds.length=0;
  go("normal"); updateMeta(); renderQuestion();
};

/* ========= P√âDANTIX (daily) ‚Äî lemmatisation FR ========= */
const wordRe = /[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø'-]+|[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø'-]+/g;
let pedState = { date:null, target:null, text:"", tokens:[], revealed:new Set(), guessed:[] };

/* mini-lemmatiseur : irr√©guliers + heuristiques suffixes */
const IRREG_FORMS = {
  /* AVOIR */
  "ai":"avoir","as":"avoir","a":"avoir","avons":"avoir","avez":"avoir","ont":"avoir",
  "avais":"avoir","avait":"avoir","avions":"avoir","aviez":"avoir","avaient":"avoir",
  "aurai":"avoir","auras":"avoir","aura":"avoir","aurons":"avoir","aurez":"avoir","auront":"avoir",
  "aurais":"avoir","aurait":"avoir","aurions":"avoir","auriez":"avoir","auraient":"avoir",
  "eu":"avoir","eue":"avoir","eus":"avoir","eut":"avoir","eues":"avoir","eumes":"avoir","eutes":"avoir","eurent":"avoir",
  "ayant":"avoir",
  /* ETRE */
  "suis":"etre","es":"etre","est":"etre","sommes":"etre","etes":"etre","sont":"etre",
  "etais":"etre","etait":"etre","etions":"etre","etiez":"etre","etaient":"etre",
  "serai":"etre","seras":"etre","sera":"etre","serons":"etre","serez":"etre","seront":"etre",
  "serais":"etre","serait":"etre","serions":"etre","seriez":"etre","seraient":"etre",
  "ete":"etre","etant":"etre",
  /* ALLER */
  "vais":"aller","vas":"aller","va":"aller","allons":"aller","allez":"aller","vont":"aller",
  "allais":"aller","allait":"aller","allions":"aller","alliez":"aller","allaient":"aller",
  "irai":"aller","iras":"aller","ira":"aller","irons":"aller","irez":"aller","iront":"aller",
  "irais":"aller","irait":"aller","irions":"aller","iriez":"aller","iraient":"aller",
  "alle":"aller","alles":"aller","allee":"aller","allees":"aller","alles":"aller","allant":"aller",
  /* FAIRE */
  "fais":"faire","fait":"faire","faisons":"faire","faites":"faire","font":"faire",
  "faisais":"faire","faisait":"faire","faisions":"faire","faisiez":"faire","faisaient":"faire",
  "ferai":"faire","feras":"faire","fera":"faire","ferons":"faire","ferez":"faire","feront":"faire",
  "ferais":"faire","ferait":"faire","ferions":"faire","feriez":"faire","feraient":"faire",
  "faits":"faire","faite":"faire","faisant":"faire",
  /* POUVOIR */
  "peux":"pouvoir","peut":"pouvoir","pouvons":"pouvoir","pouvez":"pouvoir","peuvent":"pouvoir",
  "pouvais":"pouvoir","pouvait":"pouvoir","pouvions":"pouvoir","pouviez":"pouvoir","pouvaient":"pouvoir",
  "pourrai":"pouvoir","pourras":"pouvoir","pourra":"pouvoir","pourrons":"pouvoir","pourrez":"pouvoir","pourront":"pouvoir",
  "pourrais":"pouvoir","pourrait":"pouvoir","pourrions":"pouvoir","pourriez":"pouvoir","pourraient":"pouvoir",
  "pu":"pouvoir","pue":"pouvoir","pus":"pouvoir","put":"pouvoir","purent":"pouvoir",
  /* DEVOIR */
  "dois":"devoir","doit":"devoir","devons":"devoir","devez":"devoir","doivent":"devoir",
  "devais":"devoir","devait":"devoir","devions":"devoir","deviez":"devoir","devaient":"devoir",
  "devrai":"devoir","devras":"devoir","devra":"devoir","devrons":"devoir","devrez":"devoir","devront":"devoir",
  "devrais":"devoir","devrait":"devoir","devrions":"devoir","devriez":"devoir","devraient":"devoir",
  "du":"devoir","due":"devoir","dus":"devoir","dut":"devoir","durent":"devoir",
  /* SAVOIR */
  "sais":"savoir","sait":"savoir","savons":"savoir","savez":"savoir","savent":"savoir",
  "savais":"savoir","savait":"savoir","savions":"savoir","saviez":"savoir","savaient":"savoir",
  "saurai":"savoir","sauras":"savoir","saura":"savoir","saurons":"savoir","saurez":"savoir","sauront":"savoir",
  "saurais":"savoir","saurait":"savoir","saurions":"savoir","sauriez":"savoir","sauraient":"savoir",
  "su":"savoir","su(e)":"savoir",
  /* VENIR */
  "viens":"venir","vient":"venir","venons":"venir","venez":"venir","viennent":"venir",
  "venais":"venir","venait":"venir","venions":"venir","veniez":"venir","venaient":"venir",
  "viendrai":"venir","viendras":"venir","viendra":"venir","viendrons":"venir","viendrez":"venir","viendront":"venir",
  "viendrais":"venir","viendrait":"venir","viendrions":"venir","viendriez":"venir","viendraient":"venir",
  "venu":"venir","venue":"venir","venus":"venir","venues":"venir","venant":"venir",
  /* VOULOIR */
  "veux":"vouloir","veut":"vouloir","voulons":"vouloir","voulez":"vouloir","veulent":"vouloir",
  "voulais":"vouloir","voulait":"vouloir","voulions":"vouloir","vouliez":"vouloir","voulaient":"vouloir",
  "voudrai":"vouloir","voudras":"vouloir","voudra":"vouloir","voudrons":"vouloir","voudrez":"vouloir","voudront":"vouloir",
  "voudrais":"vouloir","voudrait":"vouloir","voudrions":"vouloir","voudriez":"vouloir","voudraient":"vouloir",
  "voulu":"vouloir","voulue":"vouloir","voulus":"vouloir","voulues":"vouloir",
  /* DIRE */
  "dis":"dire","dit":"dire","disons":"dire","dites":"dire","disent":"dire",
  "disais":"dire","disait":"dire","disions":"dire","disiez":"dire","disaient":"dire",
  "dirai":"dire","diras":"dire","dira":"dire","dirons":"dire","direz":"dire","diront":"dire",
  "dirais":"dire","dirait":"dire","dirions":"dire","diriez":"dire","diraient":"dire",
  "dits":"dire","dite":"dire","disant":"dire",
  /* METTRE */
  "mets":"mettre","met":"mettre","mettons":"mettre","mettez":"mettre","mettent":"mettre",
  "mettais":"mettre","mettait":"mettre","mettions":"mettre","mettiez":"mettre","mettaient":"mettre",
  "mettrai":"mettre","mettras":"mettre","mettra":"mettre","mettrons":"mettre","mettrez":"mettre","mettront":"mettre",
  "mettrais":"mettre","mettrait":"mettre","mettrions":"mettre","mettriez":"mettre","mettraient":"mettre",
  "mis":"mettre","mise":"mettre","mises":"mettre","mettant":"mettre",
  /* PRENDRE */
  "prends":"prendre","prend":"prendre","prenons":"prendre","prenez":"prendre","prennent":"prendre",
  "prenais":"prendre","prenait":"prendre","prenions":"prendre","preniez":"prendre","prenaient":"prendre",
  "prendrai":"prendre","prendras":"prendre","prendra":"prendre","prendrons":"prendre","prendrez":"prendre","prendront":"prendre",
  "prendrais":"prendre","prendrait":"prendre","prendrions":"prendre","prendriez":"prendre","prendraient":"prendre",
  "pris":"prendre","prise":"prendre","prises":"prendre","prenant":"prendre",
  /* VOIR */
  "vois":"voir","voit":"voir","voyons":"voir","voyez":"voir","voient":"voir",
  "voyais":"voir","voyait":"voir","voyions":"voir","voyiez":"voir","voyaient":"voir",
  "verrai":"voir","verras":"voir","verra":"voir","verrons":"voir","verrez":"voir","verront":"voir",
  "verrais":"voir","verrait":"voir","verrions":"voir","verriez":"voir","verraient":"voir",
  "vu":"voir","vue":"voir","vues":"voir","vus":"voir",
  /* TENIR */
  "tiens":"tenir","tient":"tenir","tenons":"tenir","tenez":"tenir","tiennent":"tenir",
  "tenais":"tenir","tenait":"tenir","tenions":"tenir","teniez":"tenir","tenaient":"tenir",
  "tiendrai":"tenir","tiendras":"tenir","tiendra":"tenir","tiendrons":"tenir","tiendrez":"tenir","tiendront":"tenir",
  "tiendrais":"tenir","tiendrait":"tenir","tiendrions":"tenir","tiendriez":"tenir","tiendraient":"tenir",
  "tenu":"tenir","tenue":"tenir","tenues":"tenir","tenus":"tenir","tenant":"tenir",
  /* PARTIR / SORTIR (mod√®le) */
  "pars":"partir","part":"partir","partons":"partir","partez":"partir","partent":"partir",
  "partais":"partir","partait":"partir","partions":"partir","partiez":"partir","partaient":"partir",
  "sorts":"sortir","sort":"sortir","sortons":"sortir","sortez":"sortir","sortent":"sortir",
  /* BOIRE */
  "bois":"boire","boit":"boire","buvons":"boire","buvez":"boire","boivent":"boire",
  "buvais":"boire","buvait":"boire","buvions":"boire","buviez":"boire","buvaient":"boire",
  "boirai":"boire","boiras":"boire","boira":"boire","boirons":"boire","boirez":"boire","boiront":"boire",
  "bu":"boire","bus":"boire","but":"boire","burent":"boire",
  /* LIRE */
  "lis":"lire","lit":"lire","lisons":"lire","lisez":"lire","lisent":"lire",
  "lisais":"lire","lisait":"lire","lisions":"lire","lisiez":"lire","lisaient":"lire",
  "lirai":"lire","liras":"lire","lira":"lire","lirons":"lire","lirez":"lire","liront":"lire",
  "lu":"lire","lus":"lire","lues":"lire","lue":"lire",
  /* ECRIRE */
  "ecris":"ecrire","ecrit":"ecrire","ecrivons":"ecrire","ecrivez":"ecrire","ecrivent":"ecrire",
  "ecrivais":"ecrire","ecrivait":"ecrire","ecrivions":"ecrire","ecriviez":"ecrire","ecrivaient":"ecrire",
  "ecrirai":"ecrire","ecriras":"ecrire","ecrira":"ecrire","ecrirons":"ecrire","ecrirez":"ecrire","ecriront":"ecrire",
  "ecrit(e)":"ecrire","ecrits":"ecrire","ecrites":"ecrire",
  /* CONNAITRE */
  "connais":"connaitre","connait":"connaitre","connaissons":"connaitre","connaissez":"connaitre","connaissent":"connaitre",
  "connaissais":"connaitre","connaissait":"connaitre","connaissions":"connaitre","connaissiez":"connaitre","connaissaient":"connaitre",
  "connai(tra)i":"connaitre",
  /* CROIRE */
  "crois":"croire","croit":"croire","croyons":"croire","croyez":"croire","croient":"croire",
  "croyais":"croire","croyait":"croire","croyions":"croire","croyiez":"croire","croyaient":"croire",
  "cru":"croire",
  /* VIVRE */
  "vis":"vivre","vit":"vivre","vivons":"vivre","vivez":"vivre","vivent":"vivre",
  "vivais":"vivre","vivait":"vivre","vivions":"vivre","viviez":"vivre","vivaient":"vivre",
  "vecu":"vivre",
  /* OUVRIR / OFFRIR (mod√®le) */
  "ouvre":"ouvrir","ouvres":"ouvrir","ouvrons":"ouvrir","ouvrez":"ouvrir","ouvrent":"ouvrir",
  "offre":"offrir","offres":"offrir","offrons":"offrir","offrez":"offrir","offrent":"offrir",
  "ouvert":"ouvrir","offert":"offrir",
  /* COURIR */
  "cours":"courir","court":"courir","courons":"courir","courez":"courir","courent":"courir",
  "courais":"courir","courait":"courir","courions":"courir","couriez":"courir","couraient":"courir",
  "couru":"courir",
  /* NAITRE / MOURIR */
  "ne":"naitre","nais":"naitre","naissons":"naitre","naissez":"naitre","naissent":"naitre","ne(e)":"naitre","nes":"naitre","nees":"naitre",
  "meurs":"mourir","meurt":"mourir","mourons":"mourir","mourez":"mourir","meurent":"mourir","mort":"mourir","morte":"mourir","morts":"mourir","mortes":"mourir",
  /* RECEVOIR / ENVOYER / VALOIR */
  "recois":"recevoir","recoit":"recevoir","recevons":"recevoir","recevez":"recevoir","recoivent":"recevoir","recu":"recevoir",
  "envoie":"envoyer","envoies":"envoyer","envoyons":"envoyer","envoyez":"envoyer","envoient":"envoyer","envoye":"envoyer","envoyes":"envoyer",
  "vaux":"valoir","vaut":"valoir","valons":"valoir","valez":"valoir","valent":"valoir","valu":"valoir",
  /* FALLOIR / PLEUVOIR (impersonnels) */
  "faut":"falloir","fallait":"falloir","faudra":"falloir","faudrait":"falloir",
  "pleut":"pleuvoir","pleuvait":"pleuvoir","pleuvra":"pleuvoir","plu":"pleuvoir",
  /* RIRE / SOURIRE */
  "ris":"rire","rit":"rire","rions":"rire","riez":"rire","rient":"rire","ri":"rire",
  "souris":"sourire","sourit":"sourire","sourions":"sourire","souriez":"sourire","sourient":"sourire","souri":"sourire"
};

function lemmaFr(rawWord){
  // retire √©lisions communes et normalise
  let w = strip(rawWord.replace(/^([ldmtscnj])'|^qu'|^jusqu'|^lorsqu'|^puisqu'/i, ""));
  if (!w) return w;
  if (IRREG_FORMS[w]) return IRREG_FORMS[w];

  // heuristiques verbales (g√©n√©riques) ‚Äî ordre important
  const rules = [
    // participes/g√©rondifs
    [/(ees|ee|es|e)$/i, "er"],  // aim√©e/aim√©s/aim√© -> aimer
    [/ant$/i, "er"],            // mangeant -> manger
    [/(ies|ie|is|it)$/i, "ir"], // fini/finis/finit -> finir (approx)
    [/(ues|ue|us|u)$/i, ""],    // voulu/voulue -> voul(oir) (irr√©gulier couvert plus haut)
    // imparfait
    [/(ais|ait|ions|iez|aient)$/i, ""],
    // futur/conditionnel 1er groupe
    [/(erai|eras|era|erons|erez|eront)$/i, "er"],
    [/(erais|erait|erions|eriez|eraient)$/i, "er"],
    // pr√©sent 1er groupe
    [/(e|es|ons|ez|ent)$/i, "er"],
    // 2e groupe -ir
    [/(irai|iras|ira|irons|irez|iront)$/i, "ir"],
    [/(irais|irait|irions|iriez|iraient)$/i, "ir"],
    [/(issons|issez|issent)$/i, "ir"],
    [/(is|it)$/i, "ir"],
    // 3e groupe divers
    [/re$/i, "re"]
  ];
  for(const [re, rep] of rules){
    if(re.test(w)){
      const stem = w.replace(re, rep);
      if(stem.length>=3) return stem;
    }
  }
  return w;
}

function tokenize(text){
  const parts = text.match(wordRe) || [];
  return parts.map(p=>{
    const isWord = /[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø'-]+/.test(p);
    const norm = isWord ? strip(p) : p;
    const lemma = isWord ? lemmaFr(p) : p;
    return { raw:p, norm, lemma, isWord };
  });
}
function titleMask(){
  if(!pedState.target) return "";
  const letters = [...pedState.target];
  const masked = letters.map(ch=>{
    if(/\s/.test(ch)) return " ";
    if(/[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø]/.test(ch)) return "‚ñà";
    return ch;
  }).join("");
  return `Titre : ${masked} (${letters.filter(c=>/[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø]/.test(c)).length} lettres)`;
}
function renderPed(){
  $("pedTitleMask").textContent = titleMask();
  const frag = document.createDocumentFragment();
  pedState.tokens.forEach(t=>{
    const span = document.createElement("span");
    span.className = "token";
    if(!t.isWord){ span.textContent = t.raw; }
    else {
      const show = pedState.revealed.has(t.norm) || pedState.revealed.has(t.lemma) || (t.norm===strip(pedState.target)) || (t.lemma===lemmaFr(pedState.target));
      span.innerHTML = show ? t.raw : `<span class="mask">${"‚ñà".repeat(Math.max(1, t.raw.length))}</span>`;
    }
    frag.appendChild(span);
  });
  const host=$("pedText"); host.innerHTML=""; host.appendChild(frag);
}
function pickDaily(){
  const entry = PED_DAILY;
  pedState.date = entry?.date || todayISO;
  pedState.target = entry?.target || "Chloroplaste";
  pedState.text = entry?.text || DEMO_DAILY[0].text;
  pedState.tokens = tokenize(pedState.text);
  pedState.revealed = new Set(); // tout masqu√©
  pedState.guessed = [];
  $("pedGuesses").innerHTML=""; $("pedScore").hidden=true;
  renderPed();
}
function guessWord(w){
  const gRaw = (w||"").trim(); if(!gRaw) return {hits:0,win:false};
  const gNorm = strip(gRaw);
  const gLemma = lemmaFr(gRaw);
  const win = gNorm === strip(pedState.target) || gLemma === lemmaFr(pedState.target);
  let hits = 0;
  if(!win){
    let found=false;
    for(const t of pedState.tokens){
      if(!t.isWord) continue;
      if(t.norm===gNorm || t.lemma===gLemma){
        pedState.revealed.add(t.norm);
        pedState.revealed.add(t.lemma);
        found=true;
      }
    }
    if(found){
      hits = pedState.tokens.filter(t => t.isWord && (t.norm===gNorm || t.lemma===gLemma)).length;
    }
  }
  renderPed();
  return {hits,win};
}
function pedHint(){
  const cand=[];
  for(const t of pedState.tokens){
    if(!t.isWord) continue;
    if(t.norm===strip(pedState.target) || t.lemma===lemmaFr(pedState.target)) continue;
    if(!pedState.revealed.has(t.norm) && !pedState.revealed.has(t.lemma)){
      cand.push(t);
    }
  }
  if(!cand.length) return;
  const t = cand[Math.floor(Math.random()*cand.length)];
  pedState.revealed.add(t.norm);
  pedState.revealed.add(t.lemma);
  renderPed();
}
$("pedInput").addEventListener("keydown",e=>{
  if(e.key!=="Enter") return;
  const val = $("pedInput").value.trim(); if(!val) return;
  const {hits,win} = guessWord(val);
  const li=document.createElement("li"); li.className="result-item";
  li.innerHTML=`<div class="num ${win?'ok':(hits>0?'ok':'ko')}">${$("pedGuesses").children.length+1}</div><div><b>${val}</b> ‚Äî ${win?'üéØ Titre trouv√© !':(hits>0?`${hits} occurrence(s)`:'0')}</div>`;
  $("pedGuesses").prepend(li);
  if(win){ $("pedScore").hidden=false; $("pedScore").textContent="BRAVO !"; }
  $("pedInput").value="";
});
$("pedReset").onclick=pickDaily;
$("pedHint").onclick=pedHint;

/* ========= Handlers d‚Äôaccueil ========= */
document.querySelectorAll("[data-go]").forEach(b=>{
  b.addEventListener("click", async () => {
    await loadData();
    const m=b.dataset.go;
    if(m==="normal"){
      elo=1000; level=eloToLevel(elo); qCount=0; goodCount=0; streak=0; wrongStreak=0; answeredTotal=0; recentIds.length=0;
      go("normal"); updateMeta(); renderQuestion();
    } else if(m==="revision"){
      go("revision"); fillMasters();
    } else if(m==="pedantix"){
      go("pedantix"); pickDaily();
    }
  });
});

/* ========= Boot ========= */
const urlMode = new URLSearchParams(location.search).get("mode") || "home";
(async function boot(){
  if(urlMode==="home"){ go("home"); return; }
  await loadData();
  if(urlMode==="normal"){
    elo=1000; level=eloToLevel(elo); qCount=0; goodCount=0; streak=0; wrongStreak=0; answeredTotal=0; recentIds.length=0;
    go("normal"); updateMeta(); renderQuestion();
  } else if(urlMode==="revision"){
    go("revision"); fillMasters();
  } else if(urlMode==="pedantix"){
    go("pedantix"); pickDaily();
  } else {
    go("home");
  }
})();
</script>
</body>
</html>
