<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plantâ€™Quiz â€” 3 modes, 10 niveaux, Elo + SÃ©mantix</title>
  <style>
    :root{--bg:#f7f7f8;--fg:#111;--muted:#666;--brand:#111;--ok:#16a34a;--ko:#ef4444}
    *{box-sizing:border-box}
    :focus-visible{outline:3px solid #11133b;outline-offset:2px}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(1.5) blur(6px);background:rgba(255,255,255,.7);border-bottom:1px solid #e5e7eb}
    nav{display:flex;gap:12px;align-items:center;max-width:1080px;margin:0 auto;padding:12px 24px}
    .brand{font-size:20px;font-weight:800;cursor:pointer}
    .meta{margin-left:auto;display:flex;gap:10px;flex-wrap:wrap}
    .pill{padding:4px 10px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;font-size:12px}
    .container{max-width:1080px;margin:0 auto;padding:24px}
    .grid{display:grid;gap:14px}
    .grid3{grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:20px}
    .btn{appearance:none;border:0;border-radius:999px;padding:10px 16px;background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
    .btn[disabled]{background:#9ca3af;cursor:not-allowed}
    .btn.outline{background:#fff;color:#111;border:1px solid #e5e7eb}
    .muted{color:var(--muted)}
    .progress{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .progress>div{height:100%;background:var(--brand)}
    .choices{display:grid;gap:10px;margin-top:12px}
    .choice{padding:14px 16px;border:1px solid #e5e7eb;border-radius:14px;text-align:left;background:#fff;color:#111;cursor:pointer}
    .choice:hover{box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .choice.selected{outline:3px solid var(--brand);border-color:var(--brand)}
    .row{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
    ol.results{display:grid;gap:12px;padding-left:0;list-style:none}
    .result-item{display:flex;gap:12px}
    .num{min-width:32px;height:32px;border-radius:999px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    .num.ok{background:var(--ok)} .num.ko{background:var(--ko)}
    img{max-height:260px;width:100%;object-fit:cover;border-radius:12px}
    .modeCard{display:flex;flex-direction:column;height:100%}
    .modeCard h3{margin:0 0 6px}
    .modeCard p{margin:0 0 14px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#f1f5f9;border:1px solid #e2e8f0;border-bottom-width:3px;padding:.1rem .4rem;border-radius:.4rem}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #e5e7eb;padding:8px 6px;text-align:left}
    .hot{color:#16a34a;font-weight:700}
    .cold{color:#ef4444;font-weight:700}
  </style>
</head>
<body>
  <header>
    <nav>
      <div id="logo" class="brand">ðŸŒ¿ Plantâ€™Quiz</div>
      <div class="meta">
        <div class="pill">Mode : <b id="modePill">Accueil</b></div>
        <div class="pill">Niveau : <b id="levelPill">1</b></div>
        <div class="pill">Elo : <b id="eloPill">1000</b></div>
        <div class="pill">Points : <b id="pointsPill">0</b></div>
        <div class="pill">Q : <b id="qposPill">0</b></div>
      </div>
    </nav>
  </header>

  <main class="container">
    <!-- ACCUEIL -->
    <section id="home" class="grid grid3">
      <div class="card modeCard">
        <h3>Quiz normal</h3>
        <p class="muted">Flux infini. DifficultÃ© adaptative (Elo) sur 10 niveaux.</p>
        <div style="margin-top:auto" class="row" justify="start"><button id="startNormal" class="btn">Commencer</button></div>
      </div>
      <div class="card modeCard">
        <h3>Quiz rÃ©vision</h3>
        <p class="muted">Sâ€™entraÃ®ner uniquement sur les questions ratÃ©es. Pas dâ€™impact sur lâ€™Elo.</p>
        <div style="margin-top:auto" class="row" justify="start"><button id="startRevision" class="btn">RÃ©viser</button></div>
      </div>
      <div class="card modeCard">
        <h3>SÃ©mantix vÃ©gÃ©tal</h3>
        <p class="muted">Devine le mot cible scientifique Ã  partir dâ€™indices sÃ©mantiques (type Semantle).</p>
        <div style="margin-top:auto" class="row" justify="start"><button id="startSemantix" class="btn">Jouer</button></div>
      </div>
    </section>

    <!-- QUIZ CHOIX -->
    <section id="quiz" class="card" hidden>
      <div class="progress"><div id="bar" style="width:0%"></div></div>
      <p class="muted" id="qCounter" style="margin:8px 0 0"></p>
      <article style="margin-top:12px">
        <h2 id="qPrompt" style="margin:0 0 12px"></h2>
        <img id="qImage" alt="illustration" style="display:none"/>
        <div class="choices" id="choices"></div>
        <div class="row">
          <button id="finishBtn" class="btn outline">Terminer</button>
          <button id="nextBtn" class="btn" disabled>Suivant</button>
        </div>
      </article>
    </section>

    <!-- SÃ‰MANTIX -->
    <section id="semantix" class="card" hidden>
      <h2 style="margin:0 0 8px">SÃ©mantix vÃ©gÃ©tal</h2>
      <p class="muted" id="semHint">Un mot scientifique secret a Ã©tÃ© choisi. Tape des mots ; je tâ€™indique la proximitÃ©.</p>
      <div class="row" style="justify-content:flex-start;margin-top:8px">
        <input id="semInput" class="choice" placeholder="Ã‰cris un mot (ex: chloroplaste) puis EntrÃ©e" />
        <button id="semGiveUp" class="btn outline">RÃ©vÃ©ler</button>
        <button id="semNew" class="btn">Nouveau mot</button>
      </div>
      <div style="margin-top:16px;overflow:auto">
        <table class="table" id="semTable">
          <thead>
            <tr><th>#</th><th>Proposition</th><th>ProximitÃ©</th><th>Indice</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- RÃ‰SULTATS -->
    <section id="results" class="card" hidden>
      <h2 style="margin:0">RÃ©sultats</h2>
      <p id="scoreLine" style="font-size:18px;margin-top:6px"></p>
      <div class="row" style="justify-content:flex-start">
        <button id="homeBtn" class="btn outline">Retour Ã  lâ€™accueil</button>
        <button id="retryBtn" class="btn">Rejouer</button>
      </div>
      <hr style="margin:16px 0"/>
      <ol id="resultsList" class="results"></ol>
    </section>
  </main>

  <footer class="container" style="text-align:center;color:#777">
    1 seul fichier. DÃ©ployable tel quel sur GitHub Pages.
  </footer>

  <script>
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // 0) OUTILS
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    const $ = (id) => document.getElementById(id);
    const sleep = (ms) => new Promise(r=>setTimeout(r,ms));
    const stripAccents = (s)=> (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'');

    // n-gram similarity (3-gram cosine) + bonus catÃ©gories (simplifiÃ©)
    function trigramSet(s){
      s = stripAccents(s.toLowerCase());
      const t=[]; for(let i=0;i<s.length-2;i++) t.push(s.slice(i,i+3));
      return t;
    }
    function cosineSim(a,b){
      const ma = new Map(); a.forEach(x=>ma.set(x,(ma.get(x)||0)+1));
      const mb = new Map(); b.forEach(x=>mb.set(x,(mb.get(x)||0)+1));
      let dot=0,na=0,nb=0; ma.forEach((va,k)=>{na+=va*va; if(mb.has(k)) dot+=va*mb.get(k)}); mb.forEach(vb=>nb+=vb*vb);
      if(na===0||nb===0) return 0; return dot/Math.sqrt(na*nb);
    }

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // 1) QUESTIONS (10 niveaux, 2 Q / niveau)
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    const QUESTIONS = [
      {id:'L1Q1', level:1, prompt:'Quelle partie rÃ©alise principalement la photosynthÃ¨se ?', choices:[{id:'a',text:'Racines'},{id:'b',text:'Feuilles',correct:true},{id:'c',text:'Fleurs'},{id:'d',text:'Graines'}], explanation:'Les feuilles contiennent des chloroplastes riches en chlorophylle.'},
      {id:'L1Q2', level:1, prompt:'La graine germe mieux avecâ€¦', choices:[{id:'a',text:'De lâ€™eau',correct:true},{id:'b',text:'Du sel'},{id:'c',text:'Aucune eau'},{id:'d',text:'Uniquement de la lumiÃ¨re'}], explanation:"L'eau dÃ©clenche l'imbibition et la reprise du mÃ©tabolisme."},
      {id:'L2Q1', level:2, prompt:'Quel pigment vert capte la lumiÃ¨re ?', choices:[{id:'a',text:'CarotÃ¨ne'},{id:'b',text:'Chlorophylle',correct:true},{id:'c',text:'Anthocyane'},{id:'d',text:'Xanthophylle'}], explanation:'La chlorophylle a/b capte surtout le rouge et le bleu.'},
      {id:'L2Q2', level:2, prompt:'Nom du tissu qui transporte la sÃ¨ve brute ?', choices:[{id:'a',text:'PhloÃ¨me'},{id:'b',text:'XylÃ¨me',correct:true},{id:'c',text:'Ã‰piderme'},{id:'d',text:'PÃ©riderme'}], explanation:'Le xylÃ¨me transporte lâ€™eau et minÃ©raux des racines vers les feuilles.'},
      {id:'L3Q1', level:3, prompt:'Quel Ã©lÃ©ment est un macroÃ©lÃ©ment essentiel ?', choices:[{id:'a',text:'Zinc'},{id:'b',text:'Azote',correct:true},{id:'c',text:'Bore'},{id:'d',text:'Cuivre'}], explanation:"Entrant majeur des acides aminÃ©s et chlorophylle."},
      {id:'L3Q2', level:3, prompt:'Organe qui ancre la plante et absorbe lâ€™eau ?', choices:[{id:'a',text:'Racine',correct:true},{id:'b',text:'Feuille'},{id:'c',text:'Fruit'},{id:'d',text:'Tige'}], explanation:'SystÃ¨me racinaire = ancrage + absorption.'},
      {id:'L4Q1', level:4, prompt:'Le phloÃ¨me transporte principalementâ€¦', choices:[{id:'a',text:'Eau et sels minÃ©raux'},{id:'b',text:'Sucres Ã©laborÃ©s',correct:true},{id:'c',text:'OxygÃ¨ne'},{id:'d',text:'COâ‚‚'}], explanation:'Des produits de la photosynthÃ¨se vers organes puits.'},
      {id:'L4Q2', level:4, prompt:'Organe reproducteur mÃ¢le chez les fleurs ?', choices:[{id:'a',text:'Pistil'},{id:'b',text:'Ã‰tamine',correct:true},{id:'c',text:'SÃ©pale'},{id:'d',text:'PÃ©tale'}], explanation:'Ã‰tamine = filet + anthÃ¨re (pollen).'},
      {id:'L5Q1', level:5, prompt:'OÃ¹ se situe le mÃ©ristÃ¨me apical racinaire ?', choices:[{id:'a',text:'Sous la coiffe',correct:true},{id:'b',text:"Dans l'Ã©piderme"},{id:'c',text:'Dans le phloÃ¨me'},{id:'d',text:"Au-dessus de l'endoderme"}], explanation:'ProtÃ©gÃ© mÃ©caniquement par la coiffe.'},
      {id:'L5Q2', level:5, prompt:'Quel gaz entre par les stomates ?', choices:[{id:'a',text:'COâ‚‚',correct:true},{id:'b',text:'Oâ‚‚ uniquement'},{id:'c',text:'Nâ‚‚ uniquement'},{id:'d',text:'CHâ‚„'}], explanation:'COâ‚‚ fixÃ© par le cycle de Calvin.'},
      {id:'L6Q1', level:6, prompt:'Nom du faisceau conducteur bois + liber ?', choices:[{id:'a',text:'Faisceau vasculaire',correct:true},{id:'b',text:'Faisceau cortical'},{id:'c',text:'PÃ©ricycle'},{id:'d',text:'Parenchyme'}], explanation:'XylÃ¨me (bois) + phloÃ¨me (liber).'},
      {id:'L6Q2', level:6, prompt:'Le phototropisme est une croissanceâ€¦', choices:[{id:'a',text:'Vers la lumiÃ¨re',correct:true},{id:'b',text:'Vers la gravitÃ©'},{id:'c',text:'Contre le vent'},{id:'d',text:'Au hasard'}], explanation:"ContrÃ´lÃ© par l'auxine et gradients lumineux."},
      {id:'L7Q1', level:7, prompt:'La double fÃ©condation produit zygote etâ€¦', choices:[{id:'a',text:'Albumen (endosperme)',correct:true},{id:'b',text:'SÃ©pales'},{id:'c',text:'PÃ©ricarpe'},{id:'d',text:'Rachis'}], explanation:'CaractÃ©ristique des Angiospermes.'},
      {id:'L7Q2', level:7, prompt:'La cuticule foliaire limite surtoutâ€¦', choices:[{id:'a',text:'La transpiration',correct:true},{id:'b',text:'La photosynthÃ¨se'},{id:'c',text:'La respiration'},{id:'d',text:'La floraison'}], explanation:'BarriÃ¨re hydrophobe (cutine + cire).'},
      {id:'L8Q1', level:8, prompt:'Transport actif des sucres dans le phloÃ¨me utilise surtoutâ€¦', choices:[{id:'a',text:'Pompes Hâº-saccharose (symport)',correct:true},{id:'b',text:'Diffusion simple'},{id:'c',text:'Canaux Kâº'},{id:'d',text:'Aquaporines'}], explanation:'Chargement apoplasmique couplÃ© au gradient de protons.'},
      {id:'L8Q2', level:8, prompt:'La zone de Caspary se trouve dansâ€¦', choices:[{id:'a',text:'Lâ€™endoderme',correct:true},{id:'b',text:'Le pÃ©ricycle'},{id:'c',text:'Le collenchyme'},{id:'d',text:'Le xylÃ¨me'}], explanation:'Bande subÃ©risÃ©e impermÃ©able de lâ€™endoderme racinaire.'},
      {id:'L9Q1', level:9, prompt:'Hormone clÃ© de la fermeture stomatique en stress hydrique ?', choices:[{id:'a',text:'IAA'},{id:'b',text:'GA'},{id:'c',text:'ABA',correct:true},{id:'d',text:'CK'}], explanation:"ABA induit la sortie d'ions â†’ fermeture."},
      {id:'L9Q2', level:9, prompt:'La photorespiration implique principalementâ€¦', choices:[{id:'a',text:'Chloroplaste, peroxysome, mitochondrie',correct:true},{id:'b',text:'Noyau et vacuole'},{id:'c',text:'Golgi'},{id:'d',text:'RÃ©ticulum lisse'}], explanation:'Voie mÃ©tabolique quand Rubisco fixe Oâ‚‚.'},
      {id:'L10Q1', level:10, prompt:'Voie de biosynthÃ¨se des isoprÃ©noÃ¯des plastidiques ?', choices:[{id:'a',text:'MVA cytosolique'},{id:'b',text:'MEP plastidiale',correct:true},{id:'c',text:'Shikimate'},{id:'d',text:'Glyoxylate'}], explanation:'MEP (DOXP) dans les plastes; MVA dans le cytosol.'},
      {id:'L10Q2', level:10, prompt:'En C4, lâ€™enzyme primaire de fixation du COâ‚‚ estâ€¦', choices:[{id:'a',text:'Rubisco'},{id:'b',text:'PEPC',correct:true},{id:'c',text:'Nitrate rÃ©ductase'},{id:'d',text:'Malate dÃ©shydrogÃ©nase'}], explanation:'La Rubisco agit ensuite dans les cellules de gaine pÃ©rivasculaire.'},
    ];

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // 2) SÃ‰MANTIX â€” mini-corpus hors ligne (dÃ©mo)
    //  - Chaque entrÃ©e: {word, cats[], hints[]}
    //  - SimilaritÃ© = trigram cosine + bonus catÃ©gories partagÃ©es
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    const SEM_CORPUS = [
      {word:'chloroplaste', cats:['physiologie','organite','photosynthese'], hints:['organite vert','contient chlorophylle','site du cycle de Calvin']},
      {word:'xyleme', cats:['anatomie','conducteur'], hints:['bois','conduit seve brute','trachÃ©ides et vaisseaux']},
      {word:'phloeme', cats:['anatomie','conducteur'], hints:['liber','transporte sucres','tubes criblÃ©s']},
      {word:'stomate', cats:['anatomie','echange','feuille'], hints:['ostiole','cellules de garde','gaz et transpiration']},
      {word:'auxine', cats:['hormone','croissance'], hints:['IAA','elongation','phototropisme']},
      {word:'rubisco', cats:['enzyme','carboxylation'], hints:['cycle de Calvin','fixation du COâ‚‚','photorespiration']},
      {word:'endoderme', cats:['anatomie','racine'], hints:['bande de Caspary','barriÃ¨re apoplastique','rÃ©gule flux']},
      {word:'cuticule', cats:['anatomie','feuille'], hints:['cire','limite transpiration','Ã©piderme']},
      {word:'ABA', cats:['hormone','stress'], hints:['fermeture stomatique','secheresse','abscission']},
      {word:'MEP', cats:['voie','metabolisme'], hints:['isoprÃ©noÃ¯des','plastidiale','DOXP']},
    ];

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // 3) PERSISTANCE & CONSTANTES
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    const LS = { elo:'pq_elo', level:'pq_level', missed:'pq_missed' };
    const DEFAULT_ELO = 1000, DEFAULT_LEVEL = 1, MAX_LEVEL = 10, K = 24;
    const levelToRating = (lvl)=> 800 + (lvl-1)*70; // 1:800 â€¦ 10:1430
    const loadNumber = (k,d)=>{ const v = Number(localStorage.getItem(k)); return Number.isFinite(v)&&v>0? v:d; };
    const saveNumber = (k,v)=> localStorage.setItem(k,String(Math.round(v)));
    const loadMissed = ()=> { try{return JSON.parse(localStorage.getItem(LS.missed)||'[]');}catch{return[]} };
    const saveMissed = (arr)=> localStorage.setItem(LS.missed, JSON.stringify([...new Set(arr)]));

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // 4) Ã‰TAT GLOBAL + DOM
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    let mode='Accueil', elo=loadNumber(LS.elo,DEFAULT_ELO), level=Math.min(Math.max(loadNumber(LS.level,DEFAULT_LEVEL),1),MAX_LEVEL), points=0, qpos=0;
    let currentQ=null, history=[];

    const logo=$('logo');
    const modePill=$('modePill'), levelPill=$('levelPill'), eloPill=$('eloPill'), pointsPill=$('pointsPill'), qposPill=$('qposPill');
    const homeSec=$('home'), quizSec=$('quiz'), semSec=$('semantix'), resultsSec=$('results');
    const startNormalBtn=$('startNormal'), startRevisionBtn=$('startRevision'), startSemBtn=$('startSemantix');
    const bar=$('bar'), qCounter=$('qCounter'), qPrompt=$('qPrompt'), qImage=$('qImage'), choicesBox=$('choices'), nextBtn=$('nextBtn'), finishBtn=$('finishBtn');
    const scoreLine=$('scoreLine'), resultsList=$('resultsList'), retryBtn=$('retryBtn'), homeBtn=$('homeBtn');

    // SÃ©mantix DOM
    const semInput=$('semInput'), semTable=$('semTable').querySelector('tbody'), semHint=$('semHint'), semGiveUp=$('semGiveUp'), semNew=$('semNew');
    let semTarget=null, semGuesses=[]; // {guess,score,hotness,hint}

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // 5) UTILITAIRES DE QUIZ
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    function updateMeta(){ modePill.textContent=mode; levelPill.textContent=level; eloPill.textContent=Math.round(elo); pointsPill.textContent=points; qposPill.textContent=qpos; saveNumber(LS.elo,elo); saveNumber(LS.level,level); }
    function expectedScore(eloA, eloB){ return 1/(1+Math.pow(10,(eloB-eloA)/400)); }
    function applyElo(isWin, qLevel){ const opp=levelToRating(qLevel); const exp=expectedScore(elo,opp); elo = elo + K*((isWin?1:0)-exp); level = Math.min(MAX_LEVEL, Math.max(1, Math.round((elo-800)/70 + 1))); }
    function show(section){ homeSec.hidden=true; quizSec.hidden=true; semSec.hidden=true; resultsSec.hidden=true; section.hidden=false; }
    function resetSession(){ points=0; qpos=0; history=[]; updateMeta(); }
    function pickQuestionForLevel(lvl){ const pool=QUESTIONS.filter(q=>Math.abs(q.level-lvl)<=1); return (pool.length? pool:QUESTIONS)[Math.floor(Math.random()*(pool.length?pool.length:QUESTIONS.length))]; }
    function pickMissedQuestion(){ const missed=loadMissed(); const pool=QUESTIONS.filter(q=>missed.includes(q.id)); if(pool.length===0) return null; return pool[Math.floor(Math.random()*pool.length)]; }
    function recordMiss(id){ const a=loadMissed(); a.push(id); saveMissed(a); }
    function clearMissIfOk(id){ const a=loadMissed().filter(x=>x!==id); saveMissed(a); }

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // 6) MODE CHOIX (NORMAL / RÃ‰VISION)
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    function renderChoiceQuestion(){
      qpos++; updateMeta();
      bar.style.width = `${Math.min(100,(qpos%10)*10)}%`;
      qCounter.textContent = `Question ${qpos}`;
      currentQ = (mode==='RÃ©vision') ? pickMissedQuestion() : pickQuestionForLevel(level);
      if(!currentQ){ showResults(); return; }
      qPrompt.textContent=currentQ.prompt; if(currentQ.imageUrl){qImage.src=currentQ.imageUrl; qImage.style.display='block';} else {qImage.style.display='none';}
      choicesBox.innerHTML='';
      (currentQ.choices||[]).forEach(c=>{ const btn=document.createElement('button'); btn.className='choice'; btn.textContent=c.text; btn.addEventListener('click',()=>{ Array.from(choicesBox.children).forEach(el=>el.classList.remove('selected')); btn.classList.add('selected'); nextBtn.disabled=false; nextBtn.dataset.picked=c.id; }); choicesBox.appendChild(btn); });
      nextBtn.disabled=true;
    }
    function handleNextChoice(){ if(!currentQ) return; const pickedId=nextBtn.dataset.picked; const correct=(currentQ.choices||[]).find(c=>c.correct); const ok= pickedId && correct && pickedId===correct.id; if(ok){points++; clearMissIfOk(currentQ.id);} else {recordMiss(currentQ.id);} if(mode==='Normal') applyElo(!!ok,currentQ.level); history.push({id:currentQ.id, ok, level:currentQ.level, prompt:currentQ.prompt, picked:(currentQ.choices||[]).find(c=>c.id===pickedId)?.text||'â€”', correctText:correct?.text||'', explanation: currentQ.explanation||''}); renderChoiceQuestion(); }

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // 7) SÃ‰MANTIX (offline, trigram + catÃ©gories)
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    function newSemTarget(){ semTarget = SEM_CORPUS[Math.floor(Math.random()*SEM_CORPUS.length)]; semGuesses=[]; semTable.innerHTML=''; semHint.textContent='Un mot scientifique secret a Ã©tÃ© choisi. Tape des mots ; je tâ€™indique la proximitÃ©.'; semInput.value=''; semInput.focus(); }
    function semScore(guess){
      const g=stripAccents(guess.trim().toLowerCase()); if(!g) return 0;
      const s1=cosineSim(trigramSet(g), trigramSet(semTarget.word.toLowerCase()));
      const cats=semTarget.cats||[]; let bonus=0; // mini bonus si le mot contient une catÃ©gorie
      cats.forEach(c=>{ if(g.includes(c)) bonus+=0.05; });
      return Math.min(1, s1+bonus);
    }
    function addSemGuess(guess){
      const score=semScore(guess);
      const prev = semGuesses.length? semGuesses[semGuesses.length-1].score : null;
      const hotness = prev===null? '' : (score>prev? 'plus chaud' : (score<prev? 'plus froid' : 'stable'));
      const hint = score>0.75? 'ðŸ”¥ TrÃ¨s proche' : score>0.5? 'ðŸ‘ Proche' : score>0.3? 'ðŸŸ¡ Moyen' : 'ðŸ§Š Loin';
      semGuesses.push({guess,score,hotness,hint});
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${semGuesses.length}</td><td>${guess}</td><td>${(score*100|0)}%</td><td class="${score>0.5?'hot':'cold'}">${hotness||hint}</td>`;
      semTable.prepend(tr);
      if(stripAccents(guess.toLowerCase())===stripAccents(semTarget.word.toLowerCase())){
        semHint.innerHTML = `âœ… Bravo ! Le mot Ã©tait <b>${semTarget.word}</b>. Indices : ${semTarget.hints.join(' Â· ')}`;
      }
    }

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // 8) RÃ‰SULTATS
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    function showResults(){ const total=history.length; const ok=history.filter(h=>h.ok).length; const pct=Math.round(ok/Math.max(1,total)*100); scoreLine.textContent=`Session : ${ok}/${total} (${pct}%) â€” Elo : ${Math.round(elo)} â€” Niveau : ${level}`; resultsList.innerHTML=''; history.forEach((h,i)=>{ const li=document.createElement('li'); li.className='result-item'; li.innerHTML=`<div class="num ${h.ok?'ok':'ko'}">${i+1}</div><div><div style="font-weight:700">[Niv ${h.level}] ${h.prompt}</div><div class="muted">Votre rÃ©ponse : <b>${h.picked}</b></div><div class="muted">Bonne rÃ©ponse : <b>${h.correctText}</b></div>${h.explanation?`<div style="margin-top:6px">ðŸ’¡ ${h.explanation}</div>`:''}</div>`; resultsList.appendChild(li); }); show(resultsSec); updateMeta(); }

    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    // 9) NAVIGATION
    // â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
    function showSec(section){ show(section); }
    function goHome(){ mode='Accueil'; updateMeta(); show(homeSec); }
    logo.addEventListener('click', goHome);
    $('homeBtn').addEventListener('click', goHome);

    $('finishBtn').addEventListener('click', showResults);
    $('retryBtn').addEventListener('click', ()=>{ if(mode==='Normal' || mode==='RÃ©vision'){ resetSession(); show(quizSec); renderChoiceQuestion(); } else { newSemTarget(); show(semSec); } });

    $('startNormal').addEventListener('click', ()=>{ resetSession(); mode='Normal'; updateMeta(); show(quizSec); renderChoiceQuestion(); });
    $('startRevision').addEventListener('click', ()=>{ resetSession(); mode='RÃ©vision'; updateMeta(); show(quizSec); renderChoiceQuestion(); });

    // Semantix events
    $('startSemantix').addEventListener('click', ()=>{ mode='SÃ©mantix'; updateMeta(); newSemTarget(); show(semSec); });
    semInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const v=semInput.value.trim(); if(v){ addSemGuess(v); semInput.value=''; } }});
    semGiveUp.addEventListener('click', ()=>{ semHint.innerHTML = `ðŸ”Ž RÃ©ponse : <b>${semTarget.word}</b> â€” Indices : ${semTarget.hints.join(' Â· ')}`; });
    semNew.addEventListener('click', ()=>{ newSemTarget(); });

    // init
    updateMeta();
  </script>
</body>
</html>
